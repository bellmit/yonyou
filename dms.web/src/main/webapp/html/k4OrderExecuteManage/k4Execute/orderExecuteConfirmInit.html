<div class="dms-search" >
	<form class="form-horizontal">
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="row ">
				
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">订单年</label>
							<div class="col-xs-8">
								<select id="orderYearId" class="bs-select form-control"
									name="orderYearName" 
									data-url="/orderExecuteConfirm/getYearList"
									 data-model="vehicle"
									data-labelValue="ORDER_YEAR" data-lableDesc="ORDER_YEAR"
									data-alwaysRefresh="true">
								</select>
								
							</div>
						</div>
					</div>
					
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">订单月</label>
							<div class="col-xs-8">
								<select id="orderMonthId" class="bs-select form-control"
									name="orderMonthName"   data-dictCode="9009">
								</select>
							</div>
						</div>
					</div>
					
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">订单周</label>
							<div class="col-xs-8">
								<select id="orderWeekId" class="bs-select form-control"
									name="orderWeekName" 
									data-url="/orderExecuteConfirm/queryWeek"
									 data-model="vehicle"
									data-labelValue="WORK_WEEK" data-lableDesc="WORK_WEEK"
									data-alwaysRefresh="true">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">订单类型</label>
							<div class="col-xs-8">
								<select id="orderTypeId" class="bs-select form-control"
									name="orderTypeName"  data-type="oemDict"
									   data-dictCode="9016">
								</select>
							</div>
						</div>
					</div>

					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4 ">订单号</label>
							<div class="col-xs-8">
								<input id="orderNoId" name="orderNoName" class="form-control"
								 type="text" />
							</div>
						</div>
					</div>
					
					<div class="col-xs-12 col-sm-12 col-md-8 col-lg-6">
						<div class="form-group">
							<label class="control-label col-xs-4 col-md-2">提报日期</label>
							<div class="col-xs-8 col-sm-10">
								<div class="input-group input-daterange">
									<input type="text" class="form-control" 
										name="lastStockInDateFrom" id="lastStockInDateFrom">
										<span class="input-group-addon">至</span>
									 <input type="text" class="form-control"  
									 	name="lastStockInDateTo"
										id="lastStockInDateTo"> <span class="input-group-btn">
										<button class="btn default input-clear" type="button">
											<i class="fa fa-close"></i>
										</button>
									</span>
								</div>
							</div>
						</div>
					</div>
					<!-- 国产 -->
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">品牌</label>
								<div class="col-xs-8">
									<select id="brandId"
										class="bs-select form-control" name="brandCode"
										data-url="/basedata/material/brand/90081001"
										data-model="manage" data-labelValue="BRAND_ID"
										data-lableDesc="BRAND_NAME">
									</select>
									
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">车系</label>
								<div class="col-xs-8">
									<select id="seriesId" parent="brandId"
										class="bs-select form-control" name="seriesName"
										data-url="/basedata/material/series/90081001/{[brandId]}"
										data-model="manage" data-labelValue="SERIES_ID"
										data-lableDesc="SERIES_NAME">
									</select>
									
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">车款</label>
								<div class="col-xs-8">
									<select id="groupId" parent="seriesId"
										class="bs-select form-control" name="groupName"
										data-url="/basedata/material/group/90081001/{[seriesId]}"
										data-model="manage" data-labelValue="GROUP_ID"
										data-lableDesc="GROUP_NAME" >
									</select>
									
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">年款</label>
								<div class="col-xs-8">
									<select id="modelId" parent="groupId"
										class="bs-select form-control" name="modelYear"
										data-url="/basedata/material/modelYear/90081001/{[groupId]}"
										data-model="manage" data-labelValue="MODEL_YEAR"
										data-lableDesc="MODEL_YEAR">
									</select>
									
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">颜色</label>
								<div class="col-xs-8">
									<select id="colorId" parent="modelId"
										class="bs-select form-control" name="colorName"
										data-url="/basedata/material/color/90081001/{[groupId]}/{[modelId]}"
										data-model="manage" data-labelValue="COLOR_CODE"
										data-lableDesc="COLOR_NAME" >
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">内饰</label>
								<div class="col-xs-8">
									<select id="trimId" parent="colorId"
										class="bs-select form-control" name="trimName"
										data-url="/basedata/material/trim/90081001/{[groupId]}/{[modelId]}/{[colorId]}"
										data-model="manage" data-labelValue="TRIM_CODE"
										data-lableDesc="TRIM_NAME" >
									</select>
									
								</div>
							</div>
						</div> 
						<!-- 国产 -->
					
					
				</div>
					<div class="row" > 
						<div class="center-block" style="width:200px;">
							<div class="query-btn">
								<a href="javascript:;" class="btn blue" data-onclickEvent="true"> <i
									class="fa fa-search" ></i> 查询
								</a> 
								<a href="javascript:;" class="btn blue"><i
									class="fa fa-undo"></i> 重置
								</a>
							</div>
						</div>
					</div>
			</div>
		</div>
			<div class="panel panel-default table-panel">
				<div class="panel-heading">
					<div class="pannel-name">订单执行确认明细</div>
				</div>
				<div class="panel-body">
					<table
						class="table table-striped table-bordered table-hover table-responsive"
						id="order_execute_confirm_info_table"></table>
				</div>
			</div>

	 
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="row ">
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">运达方代码 </label>
							<div class="col-xs-8">
								<input id="dealerCodeId" name="dealerCodeName"
								 class="form-control" 
								 type="text"  data-fieldName="DEALER_CODE" readonly/>
							</div>
						</div>
					</div>

					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-3">收货地址</label>
							<div class="col-xs-8">
								<input id="addressId" name="addressName" class="form-control"
								 type="text" data-fieldName="ADDRESS" readonly />
							</div>
						</div>
					</div>
					
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">订单付款方式</label>
							<div class="col-xs-8">
								<select id="paymentTypeId" class="bs-select form-control"
									name="paymentTypeName" 
									data-url="/orderExecuteConfirm/getPaymentList"
									data-model="vehicle" 
									data-labelValue="value" 
									data-lableDesc="key" data-existsDefault="false" >
								</select>
								<input type="hidden" id="orderNos" name="orderNos" >
							</div>
						</div>
					</div>
					
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">是否使用返利</label>
							<div class="col-xs-8">
								<input id="isRebate" name="isRebate" type="radio"
									data-type="oemDict" data-dictCode="1004" data-value="10041001" />
							</div>
						</div>
					</div>
					
			</div>
			
				<div class="row">
					<div class="form-actions">
						<a class="btn blue"  
						data-url="/orderExecuteConfirm/orderExecuteConfirmCommit"
						 data-model="vehicle" data-toggle="confirmation"
						 data-callBack="true"  data-beforeRequest="true"
						 data-errorCallBack="true" data-method="POST">
							<i class="fa fa-save"></i>确认
						</a>
					</div>
				</div>
				
			</div>
		</div>
	</form> 

</div>
<script type="text/javascript">

    $(document).one("onload.dms",function(event,container){
    	//创建表格
    	new Datatable().initPagination({
    		src : "order_execute_confirm_info_table",
    		container:container,
    		   url : dmsCommon.getDmsPath()["vehicle"] + "/orderExecuteConfirm/orderExecuteConfirmInfo",
    		   checkboxHeader:true,
    		   selectItemName:"orderNos",
    		   columns : [ 
    			    {checkbox:true,sortable : false},
                    {field : "ORDER_NO",title : "订单号"},
                    {field : "ORDER_TYPE",title : "订单类型",codeFormat : {type:"oemDict",codeType:"9016"}},
                    {field : "EC_ORDER_NO",title : "官网订单号"},
                    {field : "VIN",title : "VIN"},
                    {field : "ORDER_DATE_CONVERT",title : "订单年月/周"},
                    {field : "ORDER_DATE",title : "提报日期"},
                    {field : "BRAND_NAME",title : "品牌"},
                    {field : "SERIES_NAME",title : "车系"},//
                    {field : "MODEL_CODE",title : "CPOS"},//含税采购价
                    {field : "MODEL_YEAR",title : "年款"},
                    {field : "GROUP_NAME",title : "车款"},
                    {field : "COLOR_NAME",title : "颜色"},
                    {field : "TRIM_NAME",title : "内饰"},
                    {field : "VEHICLE_USE",title : "车辆用途",codeFormat : {type:"oemDict",codeType:"7010"}}
    			],
		    	//当出现选择操作的按钮时，响应事件
				onCheck:function(row){
					console.log(row);
				},
				onLoadSuccess : function() {
			    	dmsCommon.ajaxRestRequest({
						url : dmsCommon.getDmsPath()["vehicle"] + "/orderExecuteConfirm/getAddressAndDealerCode",
						type : 'GET',
						sucessCallBack : function(data) {
							$("#dealerCodeId",getElementContext()).setDmsValue(data.DEALER_CODE);
							$("#addressId",getElementContext()).setDmsValue(data.ADDRESS);
						}
					}); 
				}
    		});
    	

    	
    	//绑定查询按钮回调
    	$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
    	});
    	
    	//执行确认订单前的执行函数
		$("a[data-beforeRequest='true']",container).on("beforeRequest.dms",function(event,returnResult){
				if($("#paymentTypeId").value==""){
    				alert("请维护付款方式");
    				returnResult.status = false;
    			}
    			//获取选中下拉框
    			var orderNos = "";
    			var selectRow = $("#order_execute_confirm_info_table",container).dmsTable().getSelections();
    			if(selectRow != null){
    				for(var i = 0 ;i<selectRow.length;i++){
    					if(orderNos=="" ){ //第一次循环为空值
    						orderNos = selectRow[i]["ORDER_NO"];
    					}else{
    						orderNos = orderNos+","+selectRow[i]["ORDER_NO"];
    					}
    				}
    			 	$("#orderNos",getElementContext()).setDmsValue(orderNos);
    			 	//订单执行确认验证（车辆用途不是普通不能使用返利）
    			 	  var isRebate="";
    			 	var radio = document.getElementsByName("isRebate"); 
    			 	  for(var i=0;i<radio.length;i++){
   			 			if(radio[i].checked==true){
   			 				isRebate=radio[i].value;
   			 			}
   			 		  }
        			dmsCommon.ajaxRestRequest({
        				url : dmsCommon.getDmsPath()["vehicle"] + "/orderExecuteConfirm/orderExecuteConfirmValidate/"+orderNos+"/"+isRebate,
        				type : 'GET',
        				sucessCallBack : function(data) {
        					if(data.FLAG == 2){
        						dmsCommon.tip({status:"warning",msg:"特殊车辆用途的订单不能使用返利"});//总共的状态类型：info、success、error、warning
        	    				returnResult.status = false; 
        	    				return ;
        					}else{
        						//校验当前订单是否为可确认状态 
        						dmsCommon.ajaxRestRequest({
        							url : dmsCommon.getDmsPath()["vehicle"] + "/orderExecuteConfirm/checkOrderNoStatus/"+orderNos,
        		    				type : 'GET',
        		    				sucessCallBack : function(data) {
        		    					if(data.FLAG){
        		    					//	dmsCommon.tip({status:"info",msg:"确认订单"});
        		    						/* returnResult.status = true; */
        		    					}else{
        		    						dmsCommon.tip({status:"warning",msg:"所选订单中有处于无效的订单！"});
        		    						returnResult.status = false;
        		    						return ;
        		    					}
        		    				}
        						});	 
        					} 
        			 	}  
        			});
    			}else{
    				dmsCommon.tip({status:"warning",msg:"请勾选要操作的车辆"});//总共的状态类型：info、success、error、warning
    				returnResult.status = false; 
    				return ;
    			}
    		returnResult.status = true;
		});
    	
		//确认订单回调函数
		$("a[data-callBack='true']",container).on("callBack.dms",function(event,response){
			//刷新表格
			$("#order_execute_confirm_info_table",getElementContext()).dmsTable().refreshTableWithForm();
		});   
    	
    	
    });

</script>
