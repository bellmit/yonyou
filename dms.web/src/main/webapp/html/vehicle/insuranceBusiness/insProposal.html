<div class="dms-search">
	<form class="form-horizontal">
		<div class="panel panel-default">
			<div class="panel-heading">
				<div class="pannel-name">查询条件</div>
				<div class="pannel-tools">
					<a href="javascript:;" class=collapse> <i
						class="fa fa-chevron-down"></i></a>
				</div>
			</div>
			<div class="panel-body">
				<div class="row">
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4 ">是否本地投保</label>
							<div class="col-xs-8">
								<select class="bs-select form-control" name="isLocal"
									id="isLocal" data-dictCode="1278" data-existsDefault="true">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4 ">是否信贷投保</label>
							<div class="col-xs-8">
								<select class="bs-select form-control" name="isCredit"
									id="isCredit" data-dictCode="1278" data-existsDefault="true">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">保险公司名称</label>
							<div class="col-xs-8">
								<select id="insCompany" class="bs-select form-control"
									name="insCompany" data-url="/vehicle/insProposal/insCompany"
									data-model="vehicle" data-labelValue="INSURATION_CODE"
									data-lableDesc="INSURATION_NAME" data-alwaysRefresh="true">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">保险顾问</label>
							<div class="col-xs-8">
								<select id="insBroker" class="bs-select form-control"
									name="insBroker" data-url="/vehicle/insProposal/insBroker"
									data-model="vehicle" data-labelValue="INS_BROKER"
									data-lableDesc="EMPLOYEE_NAME" data-alwaysRefresh="true">
								</select>
							</div>
						</div>
					</div>

					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">投保人姓名</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id=proposalName
									name="proposalName">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">VIN</label>
							<div class="col-xs-8">
							<input type="hidden" class="form-control" id=vin2 name="vin2">
							<input type="hidden" class="form-control" id=proposalCode2 name="proposalCode2">
							<input type="hidden" class="form-control" id=proposalCode name="proposalCode">
								<input type="text" class="form-control" id=vin name="vin">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">车牌号</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id="license"
									name="license">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">品牌</label>
							<div class="col-xs-8">
								<select id="brand" class="bs-select form-control" name="brandId"
									data-url="/basedata/brandsdict" data-model="manage"
									data-labelValue="BRAND_CODE" data-lableDesc="BRAND_NAME">
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
				<div class="form-group">
					<label class="control-label col-xs-4">车系</label>
					<div class="col-xs-8">
						<select id="series" class="bs-select form-control"
							name="seriesCode" data-url="/basedata/selectSeries"
							data-model="manage" data-labelValue="SERIES_CODE"
							data-lableDesc="SERIES_NAME" data-alwaysRefresh="true">
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
				<div class="form-group">
					<label class="control-label col-xs-4">车型</label>
					<div class="col-xs-8">
						<select id="model" class="bs-select form-control" name="modelCode"
							data-url="/basedata/selectModel" data-model="manage"
							data-labelValue="MODEL_CODE" data-lableDesc="MODEL_NAME"
							data-alwaysRefresh="true">
						</select>
					</div>
				</div>
			</div>

			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
				<div class="form-group">
					<label class="control-label col-xs-4 ">投保类型</label>
					<div class="col-xs-8">
						<select class="bs-select form-control" name="proposalType"
							id="proposalType" data-dictCode="1222" data-existsDefault="true">
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-12 col-sm-12 col-md-3 col-lg-3">
				<div class="form-group">
					<label class="control-label col-xs-4 ">投保渠道</label>
					<div class="col-xs-8">
						<select class="bs-select form-control" name="insChannl"
							id="insChannl" data-dictCode="1150" data-existsDefault="true">
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
				<div class="form-group">
					<label class="control-label col-xs-4">跟踪人</label>
					<div class="col-xs-8">
						<select id="trackPeople" name="trackPeople"
							class="bs-select form-control "
							data-url="/basedata/employees/-1/salesConsultant"
							data-model="manage" data-labelValue="USER_ID" data-value=""
							data-lableDesc="USER_NAME">
						</select>
					</div>
				</div>
			</div>
			<div class="col-xs-12 col-sm-6 col-md-3 col-lg-6">
				<div class="form-group">
					<label class="control-label col-xs-2">完成日期</label>
					<div class="col-xs-10">
						<div class="input-group input-daterange">
							<input type="text" class="form-control" readonly
								name="completedDateB"> <span class="input-group-addon">至</span>
							<input type="text" class="form-control" readonly
								name="completedDateE">
						</div>
					</div>
				</div>
			</div>
		<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
			<div class="form-group">
				<label class="control-label col-xs-4 ">状态</label>
				<div class="col-xs-8">
					<select class="bs-select form-control" name="formStatus"
						id="formStatus" data-dictCode="1229" data-existsDefault="true">
					</select>
				</div>
			</div>
		</div>
		<div class="col-xs-12 col-sm-6 col-md-3 col-lg-6">
			<div class="form-group">
				<label class="control-label col-xs-2 ">保险销售日期</label>
				<div class="col-xs-10">
					<div class="input-group input-daterange" data-defaultDays="7">
									<input type="text" class="form-control" readonly
										name="insSalesDate" id="insSalesDate" > <span
										class="input-group-addon">到</span> <input type="text"
										class="form-control" readonly name="insSalesDateEnd"
										id="insSalesDateEnd"> <span class="input-group-btn">
										<button class="btn default input-clear" type="button">
											<i class="fa fa-close"></i>
										</button>
									</span>
								</div>
				</div>
			</div>
		</div>

		<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
			<div class="form-group">
				<label class="control-label col-xs-4">是否新增续保</label>
				<div class="col-xs-8">
					<select class="bs-select form-control" name="isAddProposal"
						id="isAddProposal" data-dictCode="1278" data-existsDefault="true">
					</select>
				</div>
			</div>
		</div>
</div>
<div class="row ">
	<div class="col-xs-12 ">
		<div class="query-btn">
			<a href="javascript:;" class="btn blue"> <i class="fa fa-search"></i>查询
			</a> <a href="javascript:;" class="btn blue"><i class="fa fa-undo"></i>重置</a>
		</div>
	</div>
</div>

<div class="panel panel-default table-panel">
	<div class="panel-heading">
		<div class="pannel-name">保险投保单列表</div>
		<div class="pannel-button">
			<div class="btn-group btn-group-sm">
				<a id="add" data-toggle="modal" data-beforeRequest="true"
					data-url="vehicle/insuranceBusiness/addInsProposal.html"
					data-width="modal-lg" data-callBack="true" class="btn btn-outline"><i
					class="fa fa-plus-square" />新增 </a>
<!-- 				/span -->
<!-- 				<a id="editOwner" data-toggle="modal" data-beforeShowEvent="true" -->
<!-- 					data-url="customer/vehicleLossRemind/owner1.html" -->
<!-- 					data-width="modal-lg" data-callBack="true" class="btn btn-outline"> -->
<!-- 					<i class="fa fa-edit"></i> 修改车主信息 -->
<!-- 				</a> -->
<!-- 				/span -->
<!-- 				<a id="remind" data-beforeShowEvent="true" class="btn btn-outline" -->
<!-- 					data-beforeShowEvent="true" -->
<!-- 					data-url="customer/vehicleLossRemind/remind.html" -->
<!-- 					data-toggle="modal" data-width="modal-lg"> <i -->
<!-- 					class="fa fa-edit" />提醒 -->
<!-- 				</a> -->
<!-- 				/span -->
<!-- 				<a id="remindRecord" data-toggle="modal" data-width="modal-lg" -->
<!-- 					class="btn btn-outline" -->
<!-- 					data-url="customer/vehicleLossRemind/remindRecord.html" -->
<!-- 					data-beforeShowEvent="true"> <i class="fa fa-search" />提醒记录 -->
<!-- 				</a> -->
				<a id="update" data-toggle="modal" data-width="modal-lg"
					data-beforeRequest="true" data-beforeShowEvent='true'
					data-url="vehicle/insuranceBusiness/insProposalTrack.html"
					class="btn btn-outline"> <i class="fa fa-edit" />修改
				</a>
				<a id="track" data-toggle="modal" data-width="modal-lg"
					data-beforeRequest="true" data-beforeShowEvent='true'
					data-url="vehicle/insuranceBusiness/insProposalTrack.html"
					class="btn btn-outline"> <i class="fa fa-edit" />跟踪
				</a>
			
				<a id="trackHistory" data-toggle="modal" data-width="modal-lg"
					data-beforeRequest="true" data-beforeShowEvent='true'
					data-url="vehicle/insuranceBusiness/trackHistory.html"
					class="btn btn-outline"> <i class="fa fa-edit" />跟踪历史
				</a>
				<a href="javascript:;" data-url=""
					data-model="vehicle" data-method="downLoad" id="excel"
					data-toggle="confirmation" class="btn btn-outline "> <i
					class="fa fa-download"></i>打印
				</a>
				<a id="surrender" data-model="vehicle" data-beforeRequest="true" class="btn btn-outline ajaxrest"
				data-validate="true" data-onclickEvent="true" data-callBack="true"><i class="fa fa-edit"></i>退保</a> 
					<a id="suss" data-model="vehicle" data-beforeRequest="true" class="btn btn-outline ajaxrest"
				data-validate="true" data-onclickEvent="true" data-callBack="true"><i class="fa fa-edit"></i>完成</a>
				
				<a href="javascript:;" data-url="/vehicle/insProposal/export"
					data-model="vehicle" data-method="downLoad" id="excel"
					data-toggle="confirmation" class="btn btn-outline "> <i
					class="fa fa-download"></i>导出
				</a>
			</div>
		</div>
	</div>
	<div class="panel-body">
		<table
			class="table table-striped table-bordered table-hover table-responsive"
			id="dms_ins"></table>
	</div>
</div>
</form>
</div>


<script type="text/javascript">
	$(document)
			.one(
					"onload.dms",
					function(event, container) {
						new Datatable().initPagination({
							src : "dms_ins",
							url : dmsCommon.getDmsPath()["vehicle"] + "/vehicle/insProposal",
							container : container,
							rowID : "VIN",
							sortName : "VIN",
							sortOrder : "asc",
							autoHeight : false,
							undefinedText : "",
							columns : [  {
								checkbox : true,
								sortable : false,
								title : "选择"
							}, {
								field : "PROPOSAL_CODE",
								title : "投保单号"
							}, {
								field : "PROPOSAL_TYPE",
								title : "投保类型",
								codeFormat : {
									type : "dict",
									codeType : "1222"
								}
							}, {
								field : "VIN",
								title : "VIN"
							}, {
								field : "LICENSE",
								title : "车牌号"
							},  {
								field : "brand_name",
								title : "品牌"
							}, {
								field : "series_name",
								title : "车系"
							}, {
								field : "MODEL_NAME",
								title : "车型"
							}, {
								field : "PROPOSAL_NAME",
								title : "投保人姓名"
							}, {
								field : "PHONE",
								title : "电话"
							}, {
								field : "MOBILE",
								title : "手机"
							}, {
								field : "ZIP_CODE",
								title : "邮编"
							}, {
								field : "ADDRESS",
								title : "地址"
							}, {
								field : "INS_BROKER",
								title : "保险顾问"
							}, {
								field : "INSURATION_CODE",
								title : "保险公司名称"
							}, {
								field : "RECEIVABLE_COM_AMOUNT",
								title : "交强险应收金额"
							}, {
								field : "RECEIVABLE_BUSI_AMOUNT",
								title : "商业险应收金额"
							}, {
								field : "TRAVEL_TAX_AMOUNT",
								title : "车船税"
							}, {
								field : "OTHER_AMOUNT",
								title : "其他业务"
							}, {
								field : "TOTAL_AMOUNT",
								title : "金额合计"
							}, {
								field : "IS_INS_LOCAL",
								title : "是否本地投保",
								codeFormat : {
									type : "dict",
									codeType : "1278"
								}
							}, {
								field : "IS_INS_CREDIT",
								title : "是否信贷投保",
								codeFormat : {
									type : "dict",
									codeType : "1278"
								}
							}, {
								field : "INS_CHANNELS",
								title : "投保渠道",
								codeFormat : {
									type : "dict",
									codeType : "1150"
								}
							}, {
								field : "TRACER",
								title : "跟踪人"
							}, {
								field : "COMPLETED_DATE",
								title : "完成日期",
								dateFormat : {
									format : "YYYY-MM-DD"
								}
							}, {
								field : "TRACE_TYPE",
								title : "跟进状态"
							}, {
								field : "FORM_STATUS",
								title : "单据状态",
								codeFormat : {
									type : "dict",
									codeType : "1229"
								}
							},
							{
								field : "IS_TRANSFER",
								title : "是否已过户",
								codeFormat : {
									type : "dict",
									codeType : "1278"
								}
							}, {
								field : "INS_SALES_DATE",
								title : "保险销售日期",
								dateFormat : {
									format : "YYYY-MM-DD"
								}
							}, {
								field : "COM_INS_CODE",
								title : "交强险保单号"
							}, {
								field : "BUSI_INS_CODE",
								title : "商业险保单号"
							}, {
								field : "REMARK",
								title : "备注"
							}, {
								field : "IS_ADD_PROPOSAL",
								title : "是否新增续保",
								codeFormat : {
									type : "dict",
									codeType : "1278"
								}
							}, {
								field : "IS_SELF_COMPANY_INSURANCE",
								title : "是否本公司投保",
								codeFormat : {
									type : "dict",
									codeType : "1278"
								}
							}]

						});

						$("a[data-beforeShowEvent='true']",container).on("beforeShow.dms",function(event,returnResult){
							var selectRow = $("#dms_ins",container).dmsTable().getSelections();
							 
							 if(!selectRow){
									dmsCommon.tip({status:"warning",msg:"请选择表格数据"});
									returnResult.status = false;
									return ;
								}
								$(this).data("pageData",{PROPOSAL_CODE:selectRow[0].PROPOSAL_CODE,LICENSE:selectRow[0].LICENSE,VIN:selectRow[0].VIN});//传递3个值
								returnResult.status = true;
							
								
							 var vins = '';
							 var proposalCodes = '';
							 for(var i = 0;i<selectRow.length;i++){
								 if(i==selectRow.length-1){
									 vins +=selectRow[i].VIN;
									 proposalCodes+=selectRow[i].PROPOSAL_CODE;
								 }else{
									 vins +=selectRow[i].VIN+',';
									 proposalCodes +=selectRow[i].PROPOSAL_CODE+',';
								 }
							 }
							 $("#vin2",container).val(vins);
							 $("#vin",container).removeClass("required");
							 $("#proposalCode2",container).val(proposalCodes);
							 $("#proposalCode",container).val(proposalCodes);
//							 $("#proposalCode",container).removeClass("required");
							returnResult.status = true;
						});
						
						$('a[data-beforeRequest="true"]',container).on('beforeRequest.dms',function(event,returnResult){
							var selectRow = $("#dms_ins",container).dmsTable().getSelections();
							
							var ids = $(this).attr('id');
							if(ids=='update'){
								if(selectRow[0].FORM_STATUS=='12291002' || selectRow[0].FORM_STATUS=='12291004' || selectRow[0].FORM_STATUS=='12291006'){
									dmsCommon.tip({status:"warning",msg:"单据状态为已成交、已完成和已结案的单据不能修改！"});
									returnResult.status=false;
								}
							}else if(ids=='track'){
								if(selectRow[0].FORM_STATUS=='12291002' || selectRow[0].FORM_STATUS=='12291004' || selectRow[0].FORM_STATUS=='12291006'){
									dmsCommon.tip({status:"warning",msg:"单据状态为已结案、已完成和已成交的单据不能修改！"});
									returnResult.status=false;
								}
							}else if(ids=='surrender'){
								if(selectRow[0].FORM_STATUS=='12291002' || selectRow[0].FORM_STATUS=='12291004'){
									//修改
									$(this).attr("data-method","PUT");
									$(this).attr("data-url","/vehicle/insProposal/update");
									returnResult.status=true;
								}else{
									dmsCommon.tip({status:"warning",msg:"单据状态只有已完成和已成交的才能退保！"});
									returnResult.status=false;
								}
							}else if(ids=='suss'){
								if(selectRow[0].FORM_STATUS =='12291005' || selectRow[0].FORM_STATUS =='12291006'){
									dmsCommon.tip({status:"warning",msg:"单据状态为已作废、已结案的单据不可完成！"});
									returnResult.status=false;
								}if(selectRow[0].FORM_STATUS =='12291004'){
									dmsCommon.tip({status:"warning",msg:"单号为" + selectRow[0].PROPOSAL_CODE + "的投保单已经完成"});
								}else{
									//修改
									$(this).attr("data-method","PUT");
									$(this).attr("data-url","/vehicle/insProposal/updateStatus");
									
								}
							}
						});
						//新增页面回调函数
						$("a[data-callBack='true']", container).on(
								"callBack.dms",
								function(event, response) {
									//关闭窗口
									$("a[data-dismiss='modal']", container).click();
									//刷新表格
									$("#dms_ins", getElementContext()).dmsTable().refreshTableWithForm();
								});
					});
</script>