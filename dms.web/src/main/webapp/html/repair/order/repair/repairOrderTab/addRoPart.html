<div class="dms-search">
	<form class="form-horizontal">
		<div class="modal-header">
			<div class="modal-title">维修发料</div>
			<div class="modal-close">
				<a data-dismiss="modal" class="btn btn-lg"> <i
					class="fa fa-remove"></i></a>
			</div>
		</div>
		
		<div class="modal-body">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="row ">
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">仓库</label>
								<div class="col-xs-8">
									<select class="bs-select form-control"
										data-url="/basedata/store/storelist" data-model="part"
										data-labelValue="STORAGE_CODE" data-fieldName="STORAGE_CODE"
										data-lableDesc="STORAGE_NAME" id="storageCode" name="storageCode">
									</select>

								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">品牌</label>
								<div class="col-xs-8">
									<select id="brand" class="bs-select form-control" name="brand"
										data-url="/basedata/brandsdict" data-model="manage"
										data-fieldName="BRAND_CODE" data-labelValue="BRAND_CODE"
										data-lableDesc="BRAND_NAME">
									</select>
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">类别</label>
								<div class="col-xs-8">
								<select class="bs-select form-control"  
								id="partGroupCode" name="partGroupCode" data-dictCode="1136">
								</select>
	
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">配件车型组</label>
								<div class="col-xs-8 col-md-8">
									<select id="partModelGroupCodeSet" name="partModelGroupCodeSet"
										class="bs-select form-control"
										data-url="/basedata/partInfos/querypartGroupCodes"
										data-model="part" data-labelValue="PART_MODEL_GROUP_CODE_SET"
										data-lableDesc="PART_MODEL_GROUP_CODE_SET">
									</select>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">配件代码</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="partNo"
										name="partNo">
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">拼音</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="spellCode"
										name="spellCode">
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">名称</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="partName"
										name="partName">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">中缀名称</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="partInfixName"
									name="partInfixName">
								</div>
							</div>
						</div>



						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">库位</label>
								<div class="col-xs-8">
									<input type="text" class="form-control"
										id="storagePositionCode" name="storagePositionCode">
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">库存大于零</label>
								<div class="col-xs-8">
								<select class="bs-select form-control"  
								id="stockOverZero" name="stockOverZero" data-dictCode="1278">
								</select>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						    <div class="form-group">
								<label class="control-label col-xs-4 ">售价大于零</label>
								<div class="col-xs-8">
								<select class="bs-select form-control"  
								id="priceOverZero"  name="priceOverZero" data-dictCode="1278">
								</select>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">备注</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="remark"
										name="remark">
								</div>
							</div>
						</div>

					</div>
					<div class="row ">
					<div class="col-xs-12 ">
						<div class="query-btn">
							<a data-onclickEvent='true' id="query"
							class="btn blue">
							<i class="fa fa-search"></i>查询
							</a>
							<a href="javascript:;" class="btn blue"><i
								class="fa fa-undo"></i>重置</a>
							<a data-onclickEvent='true' id="instead_part"
							   class="btn blue"  disabled="disabled"> 
							   替换件</a>

						</div>
					</div>
				</div>

				</div>
			</div>


			<div class="panel panel-default table-panel">
				<div class="panel-body">
					<table
						class="table table-striped table-bordered table-hover table-responsive"
						id="queryPart_table">
					</table>
				</div>
			</div>

		</div>
</form>
<!-- 分割 -->
<form class="form-horizontal">
		<div class="modal-body">
			<div class="panel panel-default">
				<div class="panel-body">

					<div class="row ">
					
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">仓库</label>
								<div class="col-xs-8">
									<select class="bs-select form-control"
										data-url="/basedata/store/storelist" data-model="part"
										data-labelValue="STORAGE_CODE" data-fieldName="STORAGE_CODE"
										disabled="disabled"
										data-lableDesc="STORAGE_NAME" id="storageCode2" name="storageCode2">
									</select>

								</div>
							</div>
						</div>


						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">配件代码</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="partNo2"
										name="partNo2" readonly="readonly">
								</div>
							</div>     
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">名称</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="partName2"
										name="partName2">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						    <div class="form-group">
								<label class="control-label col-xs-4 ">主要配件</label>
								<div class="col-xs-8">
								<select class="bs-select form-control"  
								id="isMainPart2" name="isMainPart2" data-dictCode="1278">
								</select>
								</div>
							</div>
						</div>
						
						
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">价格类型</label>
								<div class="col-xs-8">
									<select id="priceType2" name="priceType2"
										class="bs-select form-control" data-dictCode="1236" 
										data-excludeItems="12361008,12361009"
										>
									</select>
								</div>
							</div>
						</div>

					   <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">价格系数</label>
								<div class="col-xs-8">
									<input type="text" class="form-control decimal"
										id="priceRate2" name="priceRate2" max="1" value="1" maxDigit="1"
										maxPrecision="2" maxlength="4">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">收费区分</label>
								<div class="col-xs-8 ">

									<select id="chargePartitionCode2" name="chargePartitionCode2"
										name="chargePartitionCode" class="bs-select form-control"
										data-url="/accessoryItem/AccessoryItem/cplist"
										data-model="repair" data-labelValue="CHARGE_PARTITION_CODE"
										data-lableDesc="CHARGE_PARTITION_NAME">
									</select>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">维修项目</label>
								<div class="col-xs-8 ">
									<select id="labourCode" name="labourCode"
										class="bs-select form-control">
									</select>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">发料单价</label>
								<div class="col-xs-8">
									<input id="partSalesPrice2" name="partSalesPrice2"
										class="form-control decimal" type="text"
										maxDigit="8"
										maxPrecision="2" data-autoValueDigits="2"/>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">发料数量</label>
								<div class="col-xs-8">
									<input id="partQuantity2" name="partQuantity2" type="text"
										class="form-control decimal" maxDigit="6"
										maxPrecision="2" />
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">发料金额</label>
								<div class="col-xs-8 ">
									<input id="partSalesAmount2" name="partSalesAmount2" readonly="readonly"
										data-autoValueDigits="2"
										class="form-control money" maxDigit="30" type="text" />
								</div>
							</div>
						</div>

		                <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4 ">备注</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="remark2"
										name="remark2" readonly="readonly">
								</div>
							</div>
						</div>

					</div>
				
			<!-- 以下为隐藏的div，用于添加配件后，清空对应表单数据 -->
				<div class="row" style="display: none">  
					<div class="col-xs-12 ">
						<div class="query-btn">
							<a href="javascript:;" class="btn blue" id="clear2"><i
								class="fa fa-undo"></i>重置</a>
						</div>
					</div>
				</div>
				</div>
			</div>
			<div class="panel panel-default table-panel">
				<div class="panel panel-default table-panel">
					<div class="panel-body">
						<table
							class="table table-striped table-bordered table-hover table-responsive"
							id="addPart_table">
						</table>
					</div>
				</div>
			</div>
			<div class="modal-footer center-block">
				<a data-beforeRequest='true' class="btn blue"
					data-toggle="confirmation"><i class="fa fa-save"></i>确定</a>
				<a data-dismiss="modal" class="btn blue"> <i class="fa fa-undo"></i>取消</a> 
		
			</div>
		</div>
	</form>
</div>
<script type="text/javascript">
$(document).one("onload.dms",function(event,container){
	
	var rowdata; // 声明一个本方法中公用的变量，变将双击选中的行记录赋值给这个变量，之后用于价格类型变动绑定事件中，根据不同价格类型获取不同价格
	
	//查询按钮，点击查询数据事件
	$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
		
		if($(this).attr('id')=='query'){
			
		$("#queryPart_table",container).dmsTable().refreshUrl(dmsCommon.getDmsPath()['repair']
        +"/order/repair/addPart/queryPart");//通过url刷新表格
		$("#queryPart_table",container).dmsTable().refreshTableWithForm();
		
			return true;
		}	
	});
	
	
	new Datatable().initPagination({
		container:container,
		src : "queryPart_table",
//  		url : dmsCommon.getDmsPath()["repair"] + "/order/repair/addPart/queryPart",
		rowID : "",
		sortName : "STORAGE_CODE",
		sortOrder : "asc",
		isQueryFirst:false,
		undefinedText : "",
		autoHeight:false,
		onClickRow(rowData, element){ //点击选中行并根据该行是否存在替代配件来决定是否启用替换配件按钮
			var inst_part=$("tr.selected",$("#queryPart_table",container)).find('td').eq(-4).text();

			if(!isStringNull(inst_part)){				
				$("a[id='instead_part']", container).removeAttr("disabled");	
			}else{
				$("a[id='instead_part']", container).attr("disabled","disabled");
			}
			
			$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
				
				if($(this).attr('id')=='instead_part'){
					
				$("#queryPart_table",container).dmsTable().refreshUrl(dmsCommon.getDmsPath()['repair']
		        +"/order/repair/addPart/queryInsteadPart/"+rowData.OPTION_NO);//通过url刷新表格
				$("#queryPart_table",container).dmsTable().refreshTableWithForm();
				$("a[id='instead_part']", container).attr("disabled","disabled");
					return true;
				}
				
				
			});
	         
		},
		onDblClickRow:function(rowData,trElement){  //双击查询出的配件信息，将信息带入到下方配件库存信息界面，并查询对应配件库存信息
// 			COST_PRICE//成本价
//             SALES_PRICE;//销售价
//             CLAIM_PRICE;//索赔价
//             NODE_PRICE//网点价
//             LATEST_PRICE//最新进货价
//             NET_COST_PRICE//含税成本价
//             INSURANCE_PRICE;//保险价
	
            rowdata=rowData;
            $("#storageCode2").setDmsValue(rowData.STORAGE_CODE);
            $("#partNo2").val(rowData.PART_NO);
            $("#partName2").val(rowData.PART_NAME);
            $("#priceType2").setDmsValue("12361002");  //修改下来框的值 
            $("#priceType2",container).removeAttr("disabled");
            $("#priceRate2").val("1");
            $("#partSalesPrice2").val(rowData.SALES_PRICE);            
            $("#partQuantity2").val("1");            
            $("#partSalesAmount2").val(rowData.SALES_PRICE*1);
            
            $("#addPart_table",container).dmsTable().refreshUrl(dmsCommon.getDmsPath()['repair']
            +"/order/repair/addPart/queryPartStock/"+rowData.PART_NO+"/"+rowData.STORAGE_CODE);//通过url刷新表格
			$("#addPart_table",container).dmsTable().refreshTableWithForm();
		},
		columns : [  {
			field : "STORAGE_CODE",
			title : "仓库"
		}, {
			field : "STORAGE_POSITION_CODE",
			title : "库位"
		}, {
			field : "PART_NO",
			title : "配件代码"
		}, {
			field : "PART_NAME",
			title : "配件名称"
		}, {
			field : "SALES_PRICE",
			title : "销售价"
		}, {
			field : "COST_PRICE",
			title : "成本价"
		}, {
			field : "USEABLE_STOCK",
			title : "可用库存"
		}, {
			field : "STOCK_QUANTITY",
			title : "账面库存"
		}, {
			field : "PART_MODEL_GROUP_CODE",
			title : "车型组集"
		}, {
			field : "REMARK",
			title : "备注"
		},{
			field : "OPTION_NO",
			title : "替代配件"
		}, {
			field : "PART_INFIX_NAME",
			title : "配件中缀"
		}, {
			field : "POS_CODE",
			title : "故障部位代码"
		}, {
			field : "POS_NAME",
			title : "故障部位"
		} ]
	});
	
	
	
	new Datatable().initPagination({
		container:container,
		src : "addPart_table",
// 		url : dmsCommon.getDmsPath()["part"] + "/partOrder/deliverOrders/111",
		rowID : "STORAGE_CODE",
		sortName : "STORAGE_CODE",
		sortOrder : "asc",
		isQueryFirst:false,
		undefinedText : "",
		autoHeight:false,
		columns : [ {
			field : "SALES_PRICE",
			title : "销售价"
		}, {
			field : "MIN_LIMIT_PRICE",
			title : "最低销售限价"
		}, {
			field : "LIMIT_PRICE",
			title : "最高销售限价"
		}, {
			field : "INSURANCE_PRICE",
			title : "保险价"
		}, {
			field : "MAX_STOCK",
			title : "最大库存"
		}, {
			field : "MIN_STOCK",
			title : "最小库存"
		}, {
			field : "STOCK_QUANTITY",
			title : "账面库存"
		}, {
			field : "USEABLE_STOCK",
			title : "可用库存"
		}, {
			field : "BORROW_QUANTITY",
			title : "借进数量"
		}, {
			field : "LEND_QUANTITY",
			title : "借出数量"
		}, {
			field : "LOCKED_QUANTITY",
			title : "锁定量"
		}, {
			field : "OPTION_NO",
			title : "替代配件"
		}, {
			field : "PART_GROUP_CODE",
			title : "配件类别"
		}, {
			field : "UNIT",
			title : "单位"
		}, {
			field : "PART_MODEL_GROUP_CODE_SET",
			title : "车型"
		}],onLoadSuccess:function(){
			
		
			//收费区分值变动绑定事件
			$("#chargePartitionCode2", container).bindChange(function(obj){
				var cpType=$("#chargePartitionCode2", container).val();
				
				switch(cpType)
				{
				case "M":	 //保险
					$("#priceType2").setDmsValue("12361007");  //修改下来框的值 
					$("#priceType2",container).removeAttr("disabled");
				  break;
				case "S":     //索赔价
					$("#priceType2").setDmsValue("12361003");  //修改下来框的值 
					$("#priceType2",container).attr("disabled","disabled");
				  break;
				default:
					$("#priceType2").setDmsValue("12361002");  //修改下来框的值 
				    $("#priceType2",container).removeAttr("disabled");
				}
			
			});
			
			//值变动绑定事件
			$("#priceRate2,#partSalesPrice2,#partQuantity2", container).bindChange(function(obj){
				
				//根据变动计算金额
				$("#partSalesAmount2").val((parseFloat($("#partSalesPrice2").val())
						 *parseFloat($("#priceRate2").val())
						 *parseFloat($("#partQuantity2").val())).toFixed(2));
			
			});
			
			//价格类型变动绑定事件
			$("#priceType2", container).bindChange(function(obj){		
				var type=$("#priceType2").val();		
				switch(type)
				{
				case "12361001":	 //成本价
					$("#partSalesPrice2").val(rowdata.COST_PRICE);
				  break;
				case "12361002":     //销售价
					$("#partSalesPrice2").val(rowdata.SALES_PRICE);
				  break;
				case "12361003":	//索赔价
					$("#partSalesPrice2").val(rowdata.CLAIM_PRICE);
				  break;	
				case "12361004":	//网点价
					$("#partSalesPrice2").val(rowdata.NODE_PRICE);
				  break;	
				case "12361005":	//最新进货价
					$("#partSalesPrice2").val(rowdata.LATEST_PRICE);
				  break;	
				case "12361006":	//含税成本价
					$("#partSalesPrice2").val(rowdata.NET_COST_PRICE);
				  break;
				case "12361007":	//保险价
					$("#partSalesPrice2").val(rowdata.INSURANCE_PRICE);
				  break;
				default:
					$("#partSalesPrice2").val("0");
				}
					
				$("#priceRate2").val("1");
				if($("#partSalesPrice2").val()==""){
					$("#partSalesPrice2").val("0");
				}
				
				//根据变动计算金额
				$("#partSalesAmount2").val((parseFloat($("#partSalesPrice2").val())
						 *parseFloat($("#priceRate2").val())
						 *parseFloat($("#partQuantity2").val())).toFixed(2));
			
		 	});
		}
	});
	
	//确定按钮点击请求前事件，添加配件
	$("a[data-beforeRequest='true']",container).on("beforeRequest.dms",function(event,returnResult){
		  
		//判断被添加的配件的仓库和配件代码的表单框是否有值
		if(isStringNull($("#storageCode2",container).val()) || isStringNull($("#partNo2",container).val()) ){
			//没有值时给出提示
			dmsCommon.tip({status:"warning",msg:"请选择配件！"});
			returnResult.status =false;
			return ;
			
		}else{
            //有值时，添加配件到工单中，需要做是否重复配件判断，该判断添加在工单的"#dms_part"表中
			var formJson =$("#addPart_table",container).dmsTable().getRowDataByIndex();
            var newRow=formJson[0];
            newRow['PART_SALES_PRICE']=$("#partSalesPrice2").val();
            newRow['LABOUR_CODE']=$("#labourCode").val();
            newRow['PART_SALES_AMOUNT']=$("#partSalesAmount2").val();
            newRow['RECEIVE_AMOUNT']=$("#partSalesAmount2").val();
            newRow['PART_QUANTITY']=$("#partQuantity2").val();
            newRow['IS_MAIN_PART']=$("#isMainPart2").val();
            newRow['CHARGE_PARTITION_CODE']=$("#chargePartitionCode2 option:selected").val();
            newRow['CHARGE_PARTITION_NAME']=$("#chargePartitionCode2 option:selected").text();
            newRow['PRICE_TYPE']=$("#priceType2 option:selected").val();

            
		
			$("#dms_part",getElementContext()).dmsTable().appendRow(newRow,true);
			//清空对应已经添加配件的表单数据
			$("a[id='clear2']",container).click();
			returnResult.status = true;
		}
	
		
	    
	});
	
	
	
});
</script>
