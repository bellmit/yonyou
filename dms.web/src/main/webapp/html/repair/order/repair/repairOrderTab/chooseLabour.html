<div class="dms-search">
	<form class="form-horizontal">
		<div class="modal-header">
			<div class="modal-close">
				<a data-dismiss="modal" class="btn btn-lg"> <i
					class="fa fa-remove"></i></a>
			</div>
			<div class="modal-title">维修项目选择</div>

		</div>
		<div class="modal-body">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="row">
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-6">
							<div class="form-group">
								<label class="control-label col-xs-3 ">项目车型组</label>
								<div class="col-xs-9">
									<select id="modelGroup" class="bs-select form-control"  multiple data-live-search="true" data-size="10" data-existsDefault = "false"
										name="modelLabourCode" data-url="/basedata/repairProject/findProjectModelList" data-model="repair"
										data-labelValue="MODEL_LABOUR_CODE" data-lableDesc="GROUP_NAME">
									</select>
								</div>
							</div>
						</div>

						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-6">
							<div class="form-group">
								<label class="control-label col-xs-3 ">对应车型</label>
								<div class="col-xs-9">
									<input type="text" class="form-control" id="model" name="model"
										readonly="readonly">
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">维修项目名称</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="LABOUR_NAME" name="labourName"
										data-fieldName="">
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">维修项目代码</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="labourCode" name="labourCode"
										data-fieldName="">
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">维修项目拼音</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="spellCode" name="spellCode"
										data-autoPinYin="#LABOUR_NAME" >
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">是否下发</label>
								<div class="col-xs-6">
									<input type="hidden" class="form-control" id="" name=""
										data-fieldName="">
									<select  class="bs-select form-control"   
										 data-dictCode="1278" 
										 id="downTag" name="downTag" >
									</select>
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<div class="form-group">
								<label class="control-label col-xs-3 ">维修项目选择</label>
								<div class="col-xs-9">
									<div class="input-group">
										<input type="hidden" id="LABOUR_CODE_L"/>
										<input id="LABOUR_CODE" readonly name="LABOUR_CODE" class="form-control" type="text"/>
										<span class="input-group-btn">
											<button class="btn default btn-sm" type="button" data-url="repair/order/repair/searchAbout/searchRepairTree.html"
												data-toggle="modal" data-width="modal-sm"> <i class="fa fa-sitemap"></i>
											</button>
											<button class="btn default input-clear" type="button">
	                                           	<i class="fa fa-close"></i>
	                                   		</button>
									   </span>
									</div>
								</div>
							</div>
						</div>
						
						
						<div class="col-xs-12 col-sm-12 col-md-8 col-lg-6">
							<div class="form-group">
								<label class="control-label col-xs-3">更新日期区间</label>
								<div class="col-xs-9">
									<div class="input-group input-daterange"									
									data-date-format="yyyy/mm/dd/hh/mm/ss">
                                        
										<input type="text" class="form-control" readonly
											name="beginDate" id="beginDate"> <span
											class="input-group-addon">至</span> <input type="text"
											class="form-control" readonly name="endDate"
											id="endDate"> <span class="input-group-btn">
											<button class="btn default input-clear" type="button">
												<i class="fa fa-close"></i>
											</button>
										</span>
									</div>

								</div>
							</div>
						</div>

					</div>
					
				<div class="panel panel-default">
						<div class="panel-heading">
							<div class="pannel-name">查询条件</div>
							<div class="pannel-tools">
								<a href="javascript:;" class="collapse"> <i
									class="fa fa-chevron-down"></i></a>
							</div>
						</div>
						<div class="panel-body">
							<div class="row" >
							<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">零件代码</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="" name=""
										data-fieldName="">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">零件名称</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="" name=""
										data-fieldName="">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">故障部位</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="" name=""
										data-fieldName="">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">故障名称</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="appName" name="appName"
										data-fieldName="">
								</div>
							</div>
						</div>
						
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">行管项目代码</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="localLabourCode" name="localLabourCode"
										data-fieldName="">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">行管项目名称</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="localNabourName" name="localNabourName"
										data-fieldName="">
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">工种</label>
								<div class="col-xs-6">
									<input type="hidden" class="form-control" id="workerTypeCode" name="workerTypeCode"
										data-fieldName="">
									<select  class="bs-select form-control"   
										 data-dictCode="" 
										 id=""  >
									</select>
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">年款</label>
								<div class="col-xs-6">
									<input type="text" class="form-control" id="modelYear" name="modelYear"/>
								</div>
							</div>
						</div>
						
						<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-6 ">标准工时为空</label>
								<div class="col-xs-6">
									<input type="hidden" class="form-control" id="" name=""
										data-fieldName="">
									<select  class="bs-select form-control"   
										 data-dictCode="1278" 
										 id="nullLabour" name="nullLabour" >
									</select>
								</div>
							</div>
						</div>
						    
						    
			
							</div>
						</div>

					</div>

				</div>

				<div class="row ">
					<div class="col-xs-12 ">
						<div class="query-btn">
							<a href="javascript:;" class="btn blue"> <i
								class="fa fa-search"></i>查询
							</a> <a href="javascript:;" class="btn blue"><i
								class="fa fa-undo"></i> 重置</a>
						</div>
					</div>
				</div>

			</div>


			


			<!--维修项目  -->
			<div class="panel panel-default panel-primary table-panel">
				<div class="panel-body">
					<table
						class="table table-striped table-bordered table-hover table-responsive"
						id="labour_table"></table>
				</div>
			</div>

			<!--维修配件  -->
			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="pannel-name">维修配件</div>					
					<div class="pannel-tools">
						<a href="javascript:;" class="expand"> <i
							class="fa fa-chevron-down"></i></a>
					</div>
				</div>
				<div class="panel-body">
					<table
						class="table table-striped table-bordered table-hover table-responsive"
						id="part_table"></table>
				</div>
				<!-- <div class="panel panel-default panel-primary table-panel">
				</div> -->
			</div>
		</div>
	<!-- </form>
	<form class="form-horizontal">
		<div class="modal-body">
			
		</div> -->
		<div class="modal-footer center-block">
		    <a data-url="repair/basedata/manager/addRepairProject.html" 
			data-width="modal-lg" data-toggle="modal" class="btn blue">
			<i class="fa fa-save"></i>新增</a>
			<a id="b_save" data-callBack="true" data-onclickEvent='true'
				class="btn blue ajaxrest"><i class="fa fa-save"></i>确定</a> <a
				data-dismiss="modal" class="btn blue"><i class="fa fa-undo"></i>取消</a>
		</div>
	</form>
</div>
<script type="text/javascript">
	$(document).one("onload.dms",function(event, container) {
		var modelMap;//定义车型代码
		dmsCommon.ajaxRestRequest({
			url:dmsCommon.getDmsPath()["repair"]+"/basedata/repairProject/findModelForInput",
			type:'GET',
			async:false,
	        sucessCallBack:function(data){
	        	modelMap = data;
	        }
		});
		
		$("select[id='modelGroup']",container).on('change',function(){
			var data = $(this).val().toString().split(",");
			var callBack = '';
			debugger
			for(var i=0;i<data.length;i++){
				if(i==data.length-1){
					callBack += modelMap[data[i]];
				}else{
					if(modelMap[data[i]]!=""){
						callBack += modelMap[data[i]]+";";
					}
				}
			}
			$("#model",container).val(callBack);
		});
		
		$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
			var $this = $(this).attr('id');
			if($this=='b_save'){
				var text = "";
				var row = $("#labour_table",container).dmsTable().getSelections();
				$.each(row,function(index,obj){
					if(obj.DOWN_TAG=='12781001'){
						if(obj.LIMIT_PRICE<obj.SALES_PRICE&&obj.LIMIT_PRICE!=0.0){
							text += obj.PART_NO+',';
						}
					}
				});
				if(text!=null&&text!=''){
					text = text.subStr(0,text.length-1);
					dmsCommon.tip({status:"warning",msg:text+"配件价格不正确!"});
					return;
				}else{
					var selectRow = $("#labour_table",container).dmsTable().getSelections();
					$.each(selectRow,function(index,row){
						row["1"] = false;
						$("#dms_table",getElementContext()).dmsTable().appendRow(row);
					});

					var selectRow2 = $("#part_table",container).dmsTable().getSelections();
					$.each(selectRow2,function(index,row){
						row["1"] = false;
						$("#dms_part",getElementContext()).dmsTable().appendRow(row);
					});
					
				}
			}
		});

						new Datatable().initPagination({
									src : "labour_table",
									container : container,
									url : dmsCommon.getDmsPath()["repair"] + "/basedata/repairProject/findRepairProjectList",
									rowID : "MODEL_LABOUR_CODE",
									sortName : "MODEL_LABOUR_CODE",
									sortOrder : "asc",
									undefinedText : "",
									autoHeight : false,
									isQueryFirst : false,
									columns : [ 
										{checkbox:true,sortable : false},
										{field : "MODEL_LABOUR_CODE",inputHiddenFormat:{},title : "维修项目车型分组代码"},
										{field : "LABOUR_CODE",title : "维修项目代码",inputHiddenFormat:{}},
										{field : "LABOUR_NAME",title : "维修项目名称",inputHiddenFormat:{}},
										{field : "REPAIR_TYPE_CODE",title : "维修类型",inputHiddenFormat:{}},
										{field : "LOCAL_LABOUR_CODE",title : "行管项目代码",inputHiddenFormat:{}},
										{field : "LOCAL_LABOUR_NAME",title : "行管项目名称",inputHiddenFormat:{}},
										{field : "STD_LABOUR_HOUR",title : "标准工时",numberFormat : {decimal : 2},inputHiddenFormat:{}},
										{field : "ASSIGN_LABOUR_HOUR",title : "派工工时",numberFormat : {decimal : 2},inputHiddenFormat:{}},
										{field : "WORKER_TYPE_CODE",title : "工种",inputHiddenFormat:{}},
										{field : "OPERATION_CODE",title : "索赔项目代码",inputHiddenFormat:{}},
										{field : "CLAIM_LABOUR",title : "索赔工时",numberFormat : {decimal : 2},inputHiddenFormat:{}},
										{field : "SPELL_CODE",title : "拼音代码",inputHiddenFormat:{}},
										{field : "REPAIR_GROUP_CODE",title : "维修项目分组代码",inputHiddenFormat:{}},
										{field : "OEM_LABOUR_HOUR",title : "总部标准工时",numberFormat : {decimal : 2},inputHiddenFormat:{}},
										{field : "DOWN_TAG",title : "是否下发",codeFormat : {type:"dict",codeType:"1278"},inputHiddenFormat:{}},
										{field : "CREATED_AT",title : "创建日期",inputHiddenFormat:{}},
										{field : "UPDATED_AT",title : "更新日期",inputHiddenFormat:{}},
										{field : "IS_MEMBER",title : "是否会员专用",codeFormat : {type:"dict",codeType:"1278"},inputHiddenFormat:{}},
										{field : "REPLACE_STATUS",title : "更新状态",inputHiddenFormat:{}}
									]
								});

						new Datatable().initPagination({
									src : "part_table",
									container : container,
									url : dmsCommon.getDmsPath()["repair"] + "/basedata/repairProject/findRepairProjectItem/{[MODEL_LABOUR_CODE]}/{[LABOUR_CODE]}/{[DOWN_TAG]}/"+nullToZero($("#vin",getElementContext()).val()),
									rowID : "PART_NO",
									sortName : "PART_NO",
									sortOrder : "asc",
									undefinedText : "",
									autoHeight : false,
									parentTable:"labour_table",
									columns : [
										{checkbox:true,sortable : false},
										{field : "PART_NO",title : "配件代码"},
										{field : "PART_NAME",title : "配件名称"},
										{field : "STORAGE_CODE",title : "仓库代码"},
										{field : "PART_MODEL_GROUP_CODE_SET",title : "车型组"},
										{field : "PART_QUANTITY",title :"<span style='color: blue;'>数量</span>",inputField : "",inputTextFormat : {}},
										{field : "STOCK_QUANTITY",title : "库存数量"},
										{field : "SALES_PRICE",title : "销售价"},
										{field : "MODEL_LABOUR_CODE",title : "维修车型分组代码"},
										{field : "LABOUR_CODE",title : "维修项目代码"},
										{field : "PART_INFIX",title : "配件中缀"},
										{field : "POS_NAME",title : "故障部位"}
									]
								});


					});
	var nullToZero = function(flag){
		return flag==null||flag==""?0:flag;
	}
</script>
