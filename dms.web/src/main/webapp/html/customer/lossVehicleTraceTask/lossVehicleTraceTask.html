<div class="dms-search">
	<form class="form-horizontal">
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="row">
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">经销商</label>
							<div class="col-xs-8">
								<select id="dealer_code" class="bs-select form-control"
									name="dealer_code"
									data-url="/stockManage/safeguard/findDealerInfo"
									data-model="vehicle" data-labelValue="dealer_code"
									data-value="{[userInfo.dealerCode]}"
									data-lableDesc="DEALER_SHORTNAME">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">车主编号</label>
							<div class="col-xs-8">
							<input type="hidden" id="ownerNo2">
						
								<input type="text" class="form-control" id="ownerNo"
									name="ownerNo">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">车主名称</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id="ownerName"
									name="ownerName">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">车牌号</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id="license"
									name="license">
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">品牌</label>
							<div class="col-xs-8">
								<select id="brand" class="bs-select form-control" name="brandId"
									data-url="/basedata/brandsdict" data-model="manage"
									data-labelValue="BRAND_CODE" data-lableDesc="BRAND_NAME">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">车系</label>
							<div class="col-xs-8">
								<select id="series" class="bs-select form-control"
									name="seriesCode" data-url="/basedata/selectSeries"
									data-model="manage" data-labelValue="SERIES_CODE"
									data-lableDesc="SERIES_NAME" data-alwaysRefresh="true">
								</select>
							</div>
						</div>
					</div>

					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">车型</label>
							<div class="col-xs-8">
								<select id="model" class="bs-select form-control"
									name="modelCode" data-url="/basedata/selectModel"
									data-model="manage" data-labelValue="MODEL_CODE"
									data-lableDesc="MODEL_NAME" data-alwaysRefresh="true">
								</select>
							</div>
						</div>
					</div>

					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
						<input type="hidden" id="vin2"/>
							<label class="control-label col-xs-4 ">VIN</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id="vin" name="vin">
							</div>
						</div>
					</div>
				</div>
				<div class="row ">
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">跟踪状态</label>
							<div class="col-xs-8">
								<select class="bs-select form-control" name="traceStatus"
									id="traceStatus" data-dictCode="1237" data-existsDefault="true">
								</select>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 col-lg-3">
						<div class="form-group">
							<label class="control-label col-xs-4">跟踪员</label>
							<div class="col-xs-8">
								<select id="trancer" name="trancer"
									class="bs-select form-control "
									data-url="/basedata/employees/-1/salesConsultant"
									data-model="manage" data-labelValue="USER_ID" data-value=""
									data-lableDesc="USER_NAME">
								</select>
							</div>
						</div>
					</div>
				</div>
				<div class="panel panel-default table-panel">
		<div class="panel-heading">
			<div class="pannel-name">流失报警录入回访列表</div>
			<div class="pannel-button">
						<div class="btn-group btn-group-sm">						
							<a id="maintainHistory" data-toggle="modal" data-width="modal-lg" class="btn btn-outline"
								data-url="customer/lossVehicleTraceTask/lossAlarmResultDetail.html" data-beforeShowEvent="true">
								<i class="fa fa-edit" />问卷录入
							</a>
							<!--/span-->
							<a id="suggestMaintain" data-toggle="modal" data-width="modal-lg" data-beforeShowEvent="true"
								data-url="customer/lossVehicleTraceTask/maintainHistory.html" class="btn btn-outline">
								<i class="fa fa-edit" />维修历史
							</a>
							<!--/span-->
							<a id="complainHistory" data-toggle="modal" data-width="modal-lg" data-beforeShowEvent="true"
								data-url="customer/lossVehicleTraceTask/taskHistory.html" class="btn btn-outline">
								<i class="fa fa-edit" />回访历史
							</a>
							<!--/span-->
							<a href="javascript:;" data-url="/customer/lossVehicleTraceTask/export"
								data-model="customer" data-method="downLoad" id="excel" 
								data-toggle="confirmation" class="btn btn-outline "> <i
								class="fa fa-download"></i>导出
							</a>
						</div>
					</div>
		</div>
		<div class="panel-body">
			<table
				class="table table-striped table-bordered table-hover table-responsive"
				id="dms_table"></table>
		</div>
	</div>
				<div class="row ">
					<div class="col-xs-12 ">
						<div class="query-btn">
							<a href="javascript:;" class="btn blue"> <i
								class="fa fa-search"></i>查询
							</a> <a href="javascript:;" class="btn blue"><i
								class="fa fa-undo"></i>重置</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</form>
</div>
<script type="text/javascript">
	$(document).one("onload.dms", function(event, container) {
		new Datatable().initPagination({
			src : "dms_table",
			url : dmsCommon.getDmsPath()["customer"]
			+ "/customer/lossVehicleTraceTask",
			container : container,
			rowID : "VIN",
			sortName : "VIN",
			sortOrder : "asc",
			autoHeight : false,
			undefinedText : "",
			 columns : [{
					checkbox : true,
					sortable : false,
					title : "选择"
				},
 							{field:"dealer_shortname",title:"经销商"},
			    			{field:"LICENSE",title:"车牌号"},
			    			{field:"OWNER_NO",title:"车主编号"},
			    			{field:"OWNER_NAME",title:"车主名称"},
			    			{field:"GENDER",title:"车主性别",codeFormat : {type : "dict",codeType : "1006"}},
			    			{field:"DELIVERER",title:"联系人"},
			    			{field:"DELIVERER_PHONE",title:"联系人电话"},
			    			{field:"DELIVERER_MOBILE",title:"联系人手机"},
			    			{field:"VIN",title:"VIN"},
			    			{field:"brand_name",title:"品牌"},
			    			{field:"series_name",title:"车系"},
			    			{field:"MODEL_NAME",title:"车型"},
			    			{field:"PHONE",title:"车主电话"},
			    			{field:"MOBILE",title:"车主手机"},
			    			{field:"E_MAIL",title:"E_MAIL"},
			    			{field:"DELIVERER_ADDRESS",title:"联系人地址"},
			    			{field:"ADDRESS",title:"车主地址"},
			    			{field:"user_name",title:"跟踪员"},
			    			{field:"TRACE_TAG",title:"结束跟踪",codeFormat : {type : "dict",codeType : "1278"}},
			    			{field:"TRACE_STATUS",title:"跟踪状态",codeFormat : {type : "dict",codeType : "1237"}},
			    			{field:"TASK_REMARK",title:"备注"},
			    			{field:"INPUT_DATE",title:"上次录入日期",dateFormat : {format : "YYYY-MM-DD"}},
			    			{field:"SALES_DATE",title:"销售日期",dateFormat : {format : "YYYY-MM-DD"}},
			    			{field:"IS_RETURN_FACTORY",title:"是否回厂",codeFormat : {type : "dict",codeType : "1278"}}
			] 
		});
		
		$("a[data-beforeShowEvent='true']",container).on("beforeShow.dms",function(event,returnResult){
			var selectRow = $("#dms_table",container).dmsTable().getSelections();
			 
			 if(!selectRow){
					dmsCommon.tip({status:"warning",msg:"请选择表格数据"});
					returnResult.status = false;
					return ;
				}
				$(this).data("pageData",{VIN:selectRow[0].VIN,LICENSE:selectRow[0].LICENSE,OWNER_NO:selectRow[0].OWNER_NO});//传递3个值
				returnResult.status = true;
			
			 var vins = '';
			 var ownerNos = '';
			 var nextMaintainMileages = '';
			 for(var i = 0;i<selectRow.length;i++){
				 if(i==selectRow.length-1){
					 vins +=selectRow[i].VIN;
					 ownerNos+=selectRow[i].OWNER_NO;
					 nextMaintainMileages +=selectRow[i].NEXT_MAINTAIN_MILEAGES;
				 }else{
					 vins +=selectRow[i].VIN+',';
					 ownerNos +=selectRow[i].OWNER_NO+',';
					 nextMaintainMileages +=selectRow[i].NEXT_MAINTAIN_MILEAGES+',';
				 }
			 }
			 $("#vin2",container).val(vins);
			 $("#vin",container).removeClass("required");
			 $("#ownerNo2",container).val(ownerNos);
			 $("#ownerNo",container).removeClass("required");
			 $("#nextMaintainMileage2",container).val(nextMaintainMileages);
			 $("#nextMaintainMileage",container).removeClass("required");
			returnResult.status = true;
			
		});
	});
</script>
