<div class="dms-search" data-pageInitCallBack= "true">
	<form class="form-horizontal">
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="panel panel-default">
					<div class="panel-heading">
						<div class="pannel-name">查询条件</div>
						<div class="pannel-tools">
							<a href="javascript:;" class=collapse> <i
								class="fa fa-chevron-down"></i></a>
						</div>
					</div>
					<div class="panel-body">
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">经销商</label>
								<div class="col-xs-8">
									<select id="DEALER_CODE" class="bs-select form-control"
										name="DEALER_CODE"
										data-url="/stockManage/safeguard/findDealerInfo"
										data-value="{[userInfo.dealerCode]}" data-model="customer"
										data-labelValue="dealer_code"
										data-lableDesc="DEALER_SHORTNAME">
									</select>
								</div>
							</div>
						</div>
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">投诉编号</label>
								<div class="col-xs-8">
									<input id="complanintNo" name="complanintNo"
										data-fieldName="COMPLAINT_NO"
										class="form-control" type="text" />
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">投诉来源</label>
								<div class="col-xs-8">
									<select id="complaintOrigin"
										class="bs-select form-control"
										data-fieldName="COMPLAINT_ORIGIN" name="complaintOrigin"
										data-dictCode="1121">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">投诉类型</label>
								<div class="col-xs-8">
									<select id="complaintType" class="bs-select form-control"
										name="complaintType" data-fieldName="COMPLAINT_TYPE"
										data-dictCode="1124">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">严重性</label>
								<div class="col-xs-8">
									<select id="complaintSerious"
										class="bs-select form-control"
										data-fieldName="COMPLAINT_SERIOUS" data-dictCode="1123"
										name="complaintSerious">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">优先级</label>
								<div class="col-xs-8">
									<select id="priority" class="bs-select form-control"
										data-fieldName="PRIORITY" data-dictCode="1122" name="priority">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">及时处理</label>
								<div class="col-xs-8">
									<select id="isIntimeDeal" class="bs-select form-control" name="isIntimeDeal"
										data-dictCode="1278" data-fieldName="IS_INTIME_DEAL">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">处理状态</label>
								<div class="col-xs-8">
									<select id="dealStatus" class="bs-select form-control" data-value="12871001"
										name="dealStatus" data-fieldName="DEAL_STATUS"
										data-dictCode="1287">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">结案状态</label>
								<div class="col-xs-8">
									<select id="closeStatus" class="bs-select form-control" name="closeStatus" data-value="11201001"
										data-fieldName="CLOSE_STATUS" data-dictCode="1120" >
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">被投诉部门</label>
								<div class="col-xs-8">
									<select id="department" class="bs-select form-control"
										name="department" data-model="report" data-fieldName="DEPARTMENT"
										data-url="/saleReport/carStores/org" data-labelValue="ORG_CODE"
										data-lableDesc="ORG_NAME">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">被投诉员工</label>
								<div class="col-xs-8">
									<select id="beComplaintEmp" name="beComplaintEmp" data-fieldName="BE_COMPLAINT_EMP"
												class="bs-select form-control "
												data-url="/basedata/employees/-1/salesConsultant"
												data-model="manage" data-labelValue="USER_ID"
												data-lableDesc="USER_NAME">
									</select>
								</div>
								<!-- data-value="{[userInfo.userId]}" -->
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">回访结果</label>
								<div class="col-xs-8">
									<select id="complaintResult" class="bs-select form-control" name="complaintResult"
										data-dictCode="1135" data-fieldName="COMPLAINT_RESULT">
									</select>
								</div>
							</div>
						</div>
						<!--/span-->
						<div class="col-xs-12 col-sm-6 col-md-4">

							<div class="form-group">
								<label class="control-label col-xs-4">接单时间</label>
								<div class="col-xs-8">
									<div class="input-group input-daterange">
										<input type="text" class="form-control" data-fieldName="COMPLAINT_DATE" name="complaintDatefrom" id="complaintDatefrom" value="">
										<span class="input-group-addon">至</span> <input type="text"
											class="form-control" name="complaintDateto" id="complaintDateto" value=""> <span
											class="input-group-btn">
											<button class="btn default input-clear" type="button">
												<i class="fa fa-close"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!--/span-->
					<div class="col-xs-12 col-sm-6 col-md-4">

						<div class="form-group">
							<label class="control-label col-xs-4">处理完成日期</label>
							<div class="col-xs-8">
								<div class="input-group input-daterange">
									<input type="text" class="form-control" data-fiedName="COMPLAINT_END_DATE" name="complaintEndDateFrom" id="complaintEndDateFrom" value="">
									<span class="input-group-addon">至</span> <input type="text"
										class="form-control" name="complaintEndDateTo" id="complaintEndDateTo" value=""> <span
										class="input-group-btn">
										<button class="btn default input-clear" type="button">
											<i class="fa fa-close"></i>
										</button>
									</span>
								</div>
							</div>
						</div>
					</div>
					<!--/span-->
					<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">处理人</label>
								<div class="col-xs-8">
									<input id="principal" name="principal" data-fieldName="PRINCIPAL" class="form-control" type="text" />
							</div>
						</div>
					</div>
					<!--/span-->
					<div class="col-xs-12 col-sm-6 col-md-4">

						<div class="form-group">
							<label class="control-label col-xs-4">结案日期</label>
							<div class="col-xs-8">
								<div class="input-group input-daterange">
									<input type="text" class="form-control" name="closeDateFrom" data-fiedName="CLOSE_DATE" id="closeDateFrom" value="">
									<span class="input-group-addon">至</span> 
									<input type="text" class="form-control" name="closeDateTo" id="closeDateTo" data-fiedName="CLOSE_DATE" value=""> 
									<span class="input-group-btn">
										<button class="btn default input-clear" type="button">
											<i class="fa fa-close"></i>
										</button>
									</span>
								</div>
							</div>
						</div>
					</div>
					<!--/span-->
					<div class="col-xs-12 col-sm-6 col-md-4">
						<div class="form-group">
							<label class="control-label col-xs-4">车牌号</label>
							<div class="col-xs-8">
								<input id="license" name="license" class="form-control "
									type="text" data-fieldName="LICENSE" />
							</div>
							<a id="add" data-url="customer/complaint/queryVehicle.html"
								class="btn btn-outline hidden" data-toggle="modal"
								data-width="modal-lg"> <i class="fa fa-plus-square"></i>
							</a>
						</div>
					</div>
					<!--/span-->
					<div class="col-xs-12 col-sm-6 col-md-4">
						<div class="form-group">
							<label class="control-label col-xs-4">车主姓名</label>
							<div class="col-xs-8">
								<input id="ownerName" name="ownerName"
									data-fieldName="OWNER_NAME" class="form-control" type="text" />
							</div>
						</div>
					</div>
					<!--/span-->
				</div>
				<div class="row ">
					<div class="col-xs-12 ">
						<div class="query-btn">
							<a href="javascript:;" class="btn btn-sm blue"> <i
								class="fa fa-search"></i> 查询
							</a> <a href="javascript:;" class="btn btn-sm blue"><i
								class="fa fa-undo"></i> 重置</a>
						</div>
					</div>
				</div>
			</div>
			<div class="panel panel-default table-panel">
				<div class="panel-heading">
					<div class="pannel-name">客户投诉处理及分析</div>
					<div class="pannel-button">
						<div class="btn-group btn-group-sm">
							<!-- /span -->
							<a id="complainHistoryDetail" data-toggle="modal" data-width="modal-lg"
								data-beforeShowEvent="true"
								data-url="customer/complaint/queryComplaint/queryComplaintDetail.html"
								class="btn btn-outline"> <i class="fa fa-search" />投诉明细
							</a>
							<!--/span-->
							<a id="complainHistory" data-toggle="modal" data-width="modal-lg"
								data-beforeShowEvent="true" data-onclickEvent="true"
								data-url="customer/solicitude/complainHistory/complainHistory.html"
								class="btn btn-outline"> <i class="fa fa-search" />投诉历史
							</a>
							<a id="maintainHistory" data-toggle="modal" data-width="modal-lg"
								class="btn btn-outline" data-onclickEvent="true"
								data-url="customer/solicitude/maintainHistory/maintainHistory.html"
								data-beforeShowEvent="true"> <i class="fa fa-search" />维修历史
							</a>
							<!--/span-->
							<!--/span-->
							<a href="javascript:;" data-url="/customer/queryComplaint/export"
								data-model="customer" data-method="downLoad" id="excel"
								data-toggle="confirmation" class="btn btn-outline "> <i
								class="fa fa-download"></i>导出
							</a>
						</div>
					</div>
				</div>
			</div>
			<div class="panel-body">
				<table
					class="table table-striped table-bordered table-hover table-responsive"
					id="dms_solicitude">
				</table>
			</div>
	</form>
</div>
<script type="text/javascript">
	$(document).one("onload.dms",function(event, container) {
				
				new Datatable().initPagination({
					src : "dms_solicitude",
					rowID : "COMPLAINT_NO",
					container : container,
					url : dmsCommon.getDmsPath()["customer"]+ "/customer/queryComplaint",
					sortName : "COMPLAINT_NO",
					undefinedText : "",
					sortOrder : "desc",
					autoHeight : false,
					columns : [ 
						{radio : true,sortable : false},
						{field : "POSITION_ID",title : "操作",operateFormat : [
							 {type : "del",url : "/customer/queryComplaint/{[COMPLAINT_NO]}",model : "customer",
								 callBack:function(response){
										$("#dms_solicitude",container).dmsTable().refreshTableWithForm();
									}
							 } ]
						},
						{field : "VIN",title : "VIN"},
						{field : "ENGINE_NO",title : "发动机号"},
						{field : "dealer_shortname",title : "经销商"},
						{field : "COMPLAINT_NO",title : "投诉编号"}, 
						{field : "COMPLAINT_TYPE",title : "投诉类型",codeFormat : {type : "dict",codeType : "1124"}},
						{field : "COMPLAINT_NAME",title : "投诉人姓名"},
						{field : "COMPLAINT_DATE",title : "接单时间",dateFormat : {format : "YYYY-MM-DD HH:mm:ss"}}, 
						{field : "ss",title : "客户经理"}, 
						{field : "user_name",title : "处理人",inputHiddenFormat : {hiddenField:"PRINCIPAL"}}, 
						{field : "TECHNICIAN",title : "责任技师"},
						{field : "TECHNICIAN_NEW",title : "维修技师"},
						{field : "DEAL_STATUS",title : "处理状态",codeFormat : {type : "dict",codeType : "1287"}},
						{field : "COMPLAINT_END_DATE",title : "处理完成日期",dateFormat : {format : "YYYY-MM-DD HH:mm:ss"}},
						{field : "dept",title : "发生部门",inputHiddenFormat : {hiddenField:"DEPARTMENT"}},
						{field : "sse",title : "投诉员工",inputHiddenFormat : {hiddenField:"BE_COMPLAINT_EMP"}}, 
						{field : "CLOSE_DATE",title : "结案日期",dateFormat : {format : "YYYY-MM-DD HH:mm:ss"}},
						{field : "COMPLAINT_RESULT",title : "回访结果",codeFormat : {type : "dict",codeType : "1135"}},
						{field : "COMPLAINT_ORIGIN",title : "投诉来源",codeFormat : {type : "dict",codeType : "1121"}}, 
						{field : "IS_INTIME_DEAL",title : "及时处理",codeFormat : {type : "dict",codeType : "1278"}}, 
						{field : "COMPLAINT_SUMMARY",title : "投诉摘要"}, 
						{field : "COMPLAINT_REASON",title : "投诉原因"},
						{field : "RESOLVENT",title : "解决方案"},
						{field : "OWNER_NAME",title : "车主姓名"},
						{field : "LICENSE",title : "车牌号"},
						{field : "RO_NO",title : "工单号"},
						{field : "SALES_PART_NO",title : "销售订单号"},
						{field : "OWNER_NO",title : "车主编号"}
						]
				});

				 $("a[data-beforeShowEvent='true']",container).on("beforeShow.dms",function(event,returnResult){
					 var selectRow = $("#dms_solicitude",container).dmsTable().getSelections();
					 
					 if(!selectRow){
							dmsCommon.tip({status:"warning",msg:"请选择表格数据"});
							returnResult.status = false;
							return ;
						}
					 
					 	
						$(this).data("pageData",{COMPLAINT_NO:selectRow[0].COMPLAINT_NO,VIN:selectRow[0].VIN,LICENSE:selectRow[0].LICENSE,RO_CREATE_DATE:selectRow[0].RO_CREATE_DATE,OWNER_NO:selectRow[0].OWNER_NO,OWNER_NAME:selectRow[0].OWNER_NAME});//传递多个值
						/* alert(selectRow[0].LICENSE);
						alert(selectRow[0].RO_CREATE_DATE); 
						alert(selectRow[0].OWNER_NAME);*/
						returnResult.status = true;
					
					 var vins = '';
					 var ownerNos = '';
					 var nextMaintainMileages = '';
					 
					 var engineNos = '';
					 var licenses = '';
					 var addresss= '';
					 
					 for(var i = 0;i<selectRow.length;i++){
						 if(i==selectRow.length-1){
							 vins +=selectRow[i].VIN;
							 ownerNos +=selectRow[i].OWNER_NO;
							 nextMaintainMileages +=selectRow[i].NEXT_MAINTAIN_MILEAGES;
							 
							 engineNos +=selectRow[i].ENGINE_NO;
							 licenses +=selectRow[i].LICENSE;
							 addresss +=selectRow[i].ADDRESS;
							 
						 }else{
							 vins +=selectRow[i].VIN+',';
							 ownerNos +=selectRow[i].OWNER_NO+',';
							 nextMaintainMileages +=selectRow[i].NEXT_MAINTAIN_MILEAGES+',';
							 
							 engineNos +=selectRow[i].ENGINE_NO+',';
							 licenses +=selectRow[i].LICENSE+',';
							 addresss +=selectRow[i].ADDRESS+',';
						 }
					 }
					 
					 $("#vin2",container).val(vins);
					 /* $("#vin",container).removeClass("required"); */
					 $("#ownerNo2",container).val(ownerNos);
					 $("#ownerNo",container).removeClass("required");
					 $("#nextMaintainMileage2",container).val(nextMaintainMileages);
					 $("#nextMaintainMileage",container).removeClass("required");
					 
					 $("#license2",container).val(licenses);
					 $("#license",container).removeClass("required");
					 $("#engineNo2",container).val(engineNos);
					 $("#engineNo",container).removeClass("required");
					 $("#address2",container).val(addresss);
					 $("#address",container).removeClass("required");
					 returnResult.status = true; 
					 
				 }); 
				 
				 
				//执行校验
				$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
					var selectRow = $("#dms_solicitude",container).dmsTable().getSelections();
					console.log(JSON.stringify(selectRow));
					debugger
					if(isStringNull(selectRow[0].LICENSE)&&isStringNull(selectRow[0].VIN)&&isStringNull(selectRow)){
					$("#complainHistory",container).attr('disabled','disabled');
					$("#maintainHistory",container).attr('disabled','disabled');
					returnResult.status = true;
					}
				});
	});
</script>