<div class="dms-edit ajaxrest">
	<form class="form-horizontal">
		<div class="modal-header">
	
			<div class="modal-title">维修领料编辑</div>
			<div class="modal-close">
				<a data-dismiss="modal" class="btn btn-lg">
				<i class="fa fa-remove"></i></a>
			</div>
		</div>
		<div class="modal-body">
			<div class="panel panel-default">

				<div class="panel-body">
					<div class="row">
	 		<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
				   <label class="control-label col-xs-4">仓库</label>
						<div class="col-xs-8">
							<input type="hidden" id="storageCode" name="storageCode"
										class="bs-select form-control" readonly="readonly"/>
							<input id="storageName" name="storageName"
										class="bs-select form-control"/>			
					    </div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件代码</label>
						<div class="col-xs-8">
						<input  readonly="readonly" id="partNo" 
										class="bs-select form-control" name="partNo">
									</select>
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">名称</label>
						<div class="col-xs-8">
						    <input readonly="readonly" id="partName" name="partName" class=" form-control"  maxlength="30" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">领料人</label>
						<div class="col-xs-8">
						    <select id="receiver" 
								name="receiver" class="bs-select form-control" data-url="/basedata/employees/-1/salesConsultant"
										data-model="manage" data-labelValue="USER_ID"
										data-lableDesc="USER_NAME"></select>			
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">维修项目</label>
						<div class="col-xs-8">
									<div class="input-group">
								<input readonly="readonly" id="labourName" name="labourName" class="bs-select form-control" type="text" />
									</div>			
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">价格类型</label>
						<div class="col-xs-8">
						    <select id="priceType" name="priceType"
										class="bs-select form-control" data-excludeItems="12361008,12361009" data-dictCode="1236" >
									</select>				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">价格系数</label>
						<div class="col-xs-8">
						    <input id="priceRate" name="priceRate" class="form-control decimal" max="1" value="1" maxDigit="1"
										maxPrecision="2" maxlength="4" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件销售单价</label>
						<div class="col-xs-8">
						    <input id="partSalesPrice" name="partSalesPrice" class="form-control decimal"maxDigit="8"
										maxPrecision="2" data-autoValueDigits="2" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件数量</label>
						<div class="col-xs-8">
						    <input id="partQuantity" name="partQuantity" readonly="readonly" class="form-control decimal" maxDigit="6"
										maxPrecision="2" maxlength="30" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件销售金额</label>
						<div class="col-xs-8">
						    <input id="partSalesAmount" name="salesPrice" readonly="readonly" data-autoValueDigits="2" class="form-control money" maxlength="30" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">收费区分</label>
								<div class="col-xs-8 ">
									<select id="chargePartitionCode" name="chargePartitionCode" data-info="charge"
											class="bs-select form-control" data-url="/basedata/ChargeCO/Charge/dictexs"
											data-model="retail" data-labelValue="CHARGE_PARTITION_CODE"
											data-lableDesc="CHARGE_PARTITION_NAME" data-ajaxSync = "true">
										</select>
								</div>
							</div>
						</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
										<div class="form-group">
											<div class="col-xs-8">
												<input type="checkbox" name="isMainPart"
													id="isMainPart" data-dictCode="1057"
													data-dictLabel="主要配件" />
											</div>
										</div>
									</div>
			
		</div>	
      </div>	
     </div>	
</div>
<div class="panel panel-default table-panel">
		<div style="border: solid 1px #DDDDDD; height: 150px; overflow-y: scroll; overflow-x: hidden">
			<table class="table table-striped table-bordered table-hover table-responsive"
				id="dms_table"></table>
		</div>
	</div>
	<div class="modal-footer ">
			<a data-onclickEvent="true" class="btn blue"> <i class="fa fa-save"></i>确定
			</a> <a data-dismiss="modal" class="btn blue"><i
				class="fa fa-undo"></i>取消</a>
		</div>
	</form>
</div>
<script type="text/javascript">
$(document).one("onload.dms",function(event,container){
	var selectMasterRow = $("#maintainPickingTbl",getElementContext).dmsTable().getFirstSelection();
	//var selectMasterRow2 = $("#maintainPickingTbl",getElementContext).dmsTable().getRowDataByIndex();
	var storageCode = selectMasterRow['STORAGE_CODE'];
	var storageName = selectMasterRow['STORAGE_NAME'];
	var partNo = selectMasterRow['PART_NO'];
	var partName = selectMasterRow['PART_NAME'];
	var receiver = selectMasterRow['RECEIVER'];
	var labourName = selectMasterRow['LABOUR_NAME'];
	var priceType = selectMasterRow['PRICE_TYPE'];
	var partSalesPrice = selectMasterRow['PART_SALES_PRICE'];
	var partQuantity = selectMasterRow['PART_QUANTITY'];
	var partSalesAmount = selectMasterRow['PART_SALES_AMOUNT'];
	var chargePartitionCode = selectMasterRow['CHARGE_PARTITION_CODE'];
	alert("chargePartitionCode = "+chargePartitionCode+" priceType = "+ priceType);
	var isMainPart = selectMasterRow['IS_MAIN_PART'];
	var isFinished = selectMasterRow["IS_FINISHED"];
	$("#storageCode",container).val(storageCode);
	$("#storageName",container).val(storageName);
	$("#partNo",container).val(partNo);
	$("#partName",container).val(partName);
	setTimeout(function(){
		$("#receiver",container).setDmsValue(receiver);
		$("#priceType",container).setDmsValue(priceType);
		$("#chargePartitionCode",container).val(chargePartitionCode);
	 },100);
	$("button[data-id='receiver'] span:first", container).html(receiver);
	$("#labourName",container).val(labourName);
	
	$("#partSalesPrice",container).val(partSalesPrice);
	$("#partQuantity",container).val(partQuantity);
	$("#partSalesAmount",container).val(partSalesAmount);
	
	if('12781001' == isMainPart){
		$("[name = isMainPart]:checkbox").attr("checked", true);
		//$("#isMainPart",container).prop("checked", "checked");
	}
	if(isFinished =='12781002'){
		$("#partName",container).removeAttr("readonly");
		$("#partQuantity",container).removeAttr("readonly");
	}
	var isChecked;
	//绑定onchange 事件
	$("[name='isMainPart']",container).bindChange(function(obj){
		isChecked = $(obj).is(':checked');
	});
	
	new Datatable().initPagination({
		src : "dms_table",
		container:container,
		url : dmsCommon.getDmsPath()['part']+"/basedata/BookPart/parts/"+partNo+"/"+storageCode,
		rowID : "PART_NO,STORAGE_CODE",
		isFormParam:true,
		undefinedText : "",
		isQueryFirst:true,
		autoHeight : false,
		columns : [ 
			{field : "SALES_PRICE",title : "销售价",
				inputHiddenFormat : {
					hiddenFieldName:"salesPrice,netCostPrice,latestPrice,nodePrice,costPrice",
					hiddenField : "SALES_PRICE,NET_COST_PRICE,LATEST_PRICE,NODE_PRICE,COST_PRICE"
				}}, 
			{field : "CLAIM_PRICE",title : "索赔价"}, 
			{field : "INSURANCE_PRICE",title : "保险价"}, 
			{field : "MIN_LIMIT_PRICE",title : "最低销售限价"},
			{field : "LIMIT_PRICE",title : "销售限价"},
			{field : "max_Stock",title : "最大库存"},
			{field : "min_stock",title : "最小库存"},
			{field : "STOCK_QUANTITY",title : "账面库存"},
			{field : "USEABLE_STOCK",title : "可用库存"},
			{field : "BORROW_QUANTITY",title : "借进数量"},
			{field : "LEND_QUANTITY",title : "借出数量"},
			{field : "LOCKED_QUANTITY",title : "锁定量"},
			{field : "OPTION_NO",title : "替代配件"},
			{field : "OPTION_STOCK",title : "替代件库存"},
			{field : "PART_GROUP_CODE",title : "配件类别"},
			{field : "UNIT",title : "单位"},
			{field : "PART_MODEL_GROUP_CODE_SET",title : "配件车型组集"}
		],onLoadSuccess:function(){
			var localTable = $("#dms_table",container).dmsTable().getRowDataByIndex();
			//收费区分值变动绑定事件
			$("#chargePartitionCode", container).bindChange(function(obj){
				var cpType=$("#chargePartitionCode", container).val();
				
				switch(cpType)
				{
				case "M":	 //保险
					$("#priceType").setDmsValue("12361007");  //修改下拉框的值 
					$("#priceType",container).removeAttr("disabled");
				  break;
				case "S":     //索赔价
					$("#priceType").setDmsValue("12361003");  //修改下拉框的值 
					$("#priceType",container).attr("disabled","disabled");
				  break;
				default:
					$("#priceType").setDmsValue("12361002");  //修改下拉框的值 
				    $("#priceType",container).removeAttr("disabled");
				}
			});
			
			//值变动绑定事件
			$("#priceRate,#partSalesPrice,#partQuantity", container).bindChange(function(obj){
				
				//根据变动计算金额
				$("#partSalesAmount").val((parseFloat($("#partSalesPrice").val())
						 *parseFloat($("#priceRate").val())
						 *parseFloat($("#partQuantity").val())).toFixed(2));
			    });
			//价格类型变动绑定事件
			$("#priceType", container).bindChange(function(obj){		
				var type=$("#priceType").val();	
				debugger;
				switch(type)
				{
				case "12361001":	 //成本价
					$("#partSalesPrice").val(localTable[0].COST_PRICE);
				  break;
				case "12361002":     //销售价
					$("#partSalesPrice").val(localTable[0].SALES_PRICE);
				  break;
				case "12361003":	//索赔价
					$("#partSalesPrice").val(localTable[0].CLAIM_PRICE);
				  break;	
				case "12361004":	//网点价
					$("#partSalesPrice").val(localTable[0].NODE_PRICE);
				  break;	
				case "12361005":	//最新进货价
					$("#partSalesPrice").val(localTable[0].LATEST_PRICE);
				  break;	
				case "12361006":	//含税成本价
					$("#partSalesPrice").val(localTable[0].NET_COST_PRICE);
				  break;
				case "12361007":	//保险价
					$("#partSalesPrice").val(localTable[0].INSURANCE_PRICE);
				  break;
				default:
					$("#partSalesPrice").val("0");
				}
					
				$("#priceRate").val("1");
				if($("#partSalesPrice").val()==""){
					$("#partSalesPrice").val("0");
				}
				
				//根据变动计算金额
				$("#partSalesAmount").val((parseFloat($("#partSalesPrice").val())
						 *parseFloat($("#priceRate").val())
						 *parseFloat($("#partQuantity").val())).toFixed(2));
			
		 	});
		}
	});
	//点击确认按钮事件
	$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
		var updateStatus = selectMasterRow["ITEM_UPDATE_STATUS"];
		var isMainPart ;
			if(updateStatus == 'U' || updateStatus == 'R'){
				updateStatus = 'U';
			}
			isChecked = $("[name='isMainPart']",container).is(':checked');
		if(isChecked){
			isMainPart = '12781001';
		}else{
			isMainPart = '12781002';
		}
		$("#maintainPickingTbl",getElementContext()).dmsTable().updateRowByIndex(selectMasterRow.index,{
			ITEM_UPDATE_STATUS:updateStatus,
			PART_NAME:$("#partName",container).val(),
			RECEIVER:$("#receiver",container).val(),
			PART_SALES_PRICE:$("#partSalesPrice",container).val(),
			PART_SALES_AMOUNT:$("#partSalesAmount",container).val(),
			PART_QUANTITY:$("#partQuantity",container).val(),
			IS_MAIN_PART:isMainPart,
			CHARGE_PARTITION_CODE:$("#chargePartitionCode",container).val()
		});
		//$("#maintainPickingTbl",getElementContext).dmsTable().refreshTableWithForm();
		$("a[data-dismiss='modal']", container).click();
	});
});
</script>
