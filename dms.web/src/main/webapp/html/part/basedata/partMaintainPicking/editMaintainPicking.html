<div class="dms-edit ajaxrest">
	<form class="form-horizontal">
		<div class="modal-header">
	
			<div class="modal-title">维修领料编辑</div>
			<div class="modal-close">
				<a data-dismiss="modal" class="btn btn-lg">
				<i class="fa fa-remove"></i></a>
			</div>
		</div>
		<div class="modal-body">
			<div class="panel panel-default">

				<div class="panel-body">
					<div class="row">
	 		<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
				   <label class="control-label col-xs-4">仓库</label>
						<div class="col-xs-8">
							<input id="storageCode" name="storageCode"
										class="bs-select form-control"/>
					    </div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件代码</label>
						<div class="col-xs-8">
						<input  id="partNo" 
										class="bs-select form-control" name="partNo">
									</select>
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-2">名称</label>
						<div class="col-xs-8">
						    <input id="partName" name="partName" class=" form-control"  maxlength="30" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">领料人</label>
						<div class="col-xs-8">
						    <select id="receiver" 
								name="receiver" class="bs-select form-control"data-url="/basedata/employees/-1/salesConsultant"
										data-model="manage" data-labelValue="USER_ID"
										data-lableDesc="USER_NAME"></select>			
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">维修项目</label>
						<div class="col-xs-8">
									<div class="input-group">
								<input id="labourName" name="labourName" class="bs-select form-control" type="text" />
									</div>			
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">价格类型</label>
						<div class="col-xs-8">
						    <select id="priceType" name="priceType"
										class="bs-select form-control"data-excludeItems="12361008,12361009" data-dictCode="1236" >
									</select>				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">价格系数</label>
						<div class="col-xs-8">
						    <input id="priceRate" name="priceRate" class="form-control decimal" max="1" value="1" maxDigit="1"
										maxPrecision="2" maxlength="4" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件销售单价</label>
						<div class="col-xs-10">
						    <input id="partSalesPrice" name="partPrice" class="form-control decimal"maxDigit="8"
										maxPrecision="2" data-autoValueDigits="2" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件数量</label>
						<div class="col-xs-8">
						    <input id="partQuantity" name="partQuantity" class="form-control decimal" maxDigit="6"
										maxPrecision="2" maxlength="30" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
				<div class="form-group">
					<label class="control-label col-xs-4">配件销售金额</label>
						<div class="col-xs-8">
						    <input id="partSalesAmount" name="salesPrice" data-autoValueDigits="2" class="form-control money" maxlength="30" type="text" />				
						</div>
				</div>
			</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
							<div class="form-group">
								<label class="control-label col-xs-4">收费区分</label>
								<div class="col-xs-8 ">
									<select id="chargePartitionCode" name="chargePartitionCode" data-info="charge"
											class="bs-select form-control required" data-url="/basedata/ChargeCO/Charge/dictexs"
											data-model="retail" data-labelValue="CHARGE_PARTITION_CODE"
											data-lableDesc="CHARGE_PARTITION_NAME" data-ajaxSync = "true">
										</select>
								</div>
							</div>
						</div>
			
			<div class="col-xs-12 col-sm-6 col-md-4">
										<div class="form-group">
											<div class="col-xs-8">
												<input type="checkbox" name="isMainPart"
													id="isMainPart" data-dictCode="1278"
													data-dictLabel="主要配件" />
											</div>
										</div>
									</div>
			
		</div>	
      </div>	
     </div>	
</div>
<div class="panel panel-default table-panel">
		<div style="border: solid 1px #DDDDDD; height: 150px; overflow-y: scroll; overflow-x: hidden">
			<table class="table table-striped table-bordered table-hover table-responsive"
				id="dms_table"></table>
		</div>
	</div>
	<div class="modal-footer ">
			<a data-onclickEvent="true" class="btn blue"
				data-toggle="confirmation"> <i class="fa fa-save"></i>确定
			</a> <a data-dismiss="modal" class="btn blue"><i
				class="fa fa-undo"></i>取消</a>
		</div>
	</form>
</div>
<script type="text/javascript">
$(document).one("onload.dms",function(event,container){
	var selectMasterRow = $("#maintainPickingTbl",getElementContext).dmsTable().getFirstSelection();
	var storageCode = selectMasterRow['STORAGE_CODE'];
	var partNo = selectMasterRow['PART_NO'];
	var partName = selectMasterRow['PART_NAME'];
	var receiver = selectMasterRow['RECEIVER'];
	var labourName = selectMasterRow['LABOUR_NAME'];
	var priceType = selectMasterRow['PRICE_TYPE'];
	var priceRate = selectMasterRow['PRICE_RATE'];
	var partSalesPrice = selectMasterRow['PART_SALES_PRICE'];
	var partQuantity = selectMasterRow['PART_QUANTITY'];
	var partSalesAmount = selectMasterRow['PART_SALES_AMOUNT'];
	var chargePartitionCode = selectMasterRow['CHARGE_PARTITION_CODE'];
	var isMainPart = selectMasterRow['IS_MAIN_PART'];
	if('12781001' == isMainPart){
		$("isMainPart",container).attr("checked", "checked");
	}
	$("#storageCode",container).val(storageCode);
	$("#partNo",container).val(partNo);
	$("#partName",container).val(partName);
	$("#receiver",container).val(receiver);
	$("#labourName",container).val(labourName);
	$("#priceType",container).val(priceType);
	$("#priceRate",container).val(priceRate);
	$("#partSalesPrice",container).val(partSalesPrice);
	$("#partQuantity",container).val(partQuantity);
	$("#partSalesAmount",container).val(partSalesAmount);
	$("#chargePartitionCode",container).val(chargePartitionCode);
	
	new Datatable().initPagination({
		src : "dms_table",
		container:container,
		url : dmsCommon.getDmsPath()['part']+"/basedata/BookPart/parts/"+partNo+"/"+storageCode,
		rowID : "PART_NO,STORAGE_CODE",
		isFormParam:true,
		undefinedText : "",
		isQueryFirst:true,
		autoHeight : false,
		columns : [ 
			{field : "SALES_PRICE",title : "销售价"}, 
			{field : "CLAIM_PRICE",title : "索赔价"}, 
			{field : "INSURANCE_PRICE",title : "保险价"}, 
			{field : "MIN_LIMIT_PRICE",title : "最低销售限价"},
			{field : "LIMIT_PRICE",title : "销售限价"},
			{field : "max_Stock",title : "最大库存"},
			{field : "min_stock",title : "最小库存"},
			{field : "STOCK_QUANTITY",title : "账面库存"},
			{field : "USEABLE_STOCK",title : "可用库存"},
			{field : "BORROW_QUANTITY",title : "借进数量"},
			{field : "LEND_QUANTITY",title : "借出数量"},
			{field : "LOCKED_QUANTITY",title : "锁定量"},
			{field : "OPTION_NO",title : "替代配件"},
			{field : "OPTION_STOCK",title : "替代件库存"},
			{field : "PART_GROUP_CODE",title : "配件类别"},
			{field : "UNIT",title : "单位"},
			{field : "PART_MODEL_GROUP_CODE_SET",title : "配件车型组集"}
		],onLoadSuccess:function(){
			
			//收费区分值变动绑定事件
			$("#chargePartitionCode", container).bindChange(function(obj){
				var cpType=$("#chargePartitionCode", container).val();
				
				switch(cpType)
				{
				case "M":	 //保险
					$("#priceType").setDmsValue("12361007");  //修改下来框的值 
					$("#priceType",container).removeAttr("disabled");
				  break;
				case "S":     //索赔价
					$("#priceType").setDmsValue("12361003");  //修改下来框的值 
					$("#priceType",container).attr("disabled","disabled");
				  break;
				default:
					$("#priceType").setDmsValue("12361002");  //修改下来框的值 
				    $("#priceType",container).removeAttr("disabled");
				}
			});
			
			//值变动绑定事件
			$("#priceRate,#partSalesPrice,#partQuantity", container).bindChange(function(obj){
				
				//根据变动计算金额
				$("#partSalesAmount").val((parseFloat($("#partSalesPrice").val())
						 *parseFloat($("#priceRate").val())
						 *parseFloat($("#partQuantity").val())).toFixed(2));
			
			});
			
			//价格类型变动绑定事件
			$("#priceType", container).bindChange(function(obj){		
				var type=$("#priceType").val();		
				switch(type)
				{
				case "12361001":	 //成本价
					$("#partSalesPrice").val(rowdata.COST_PRICE);
				  break;
				case "12361002":     //销售价
					$("#partSalesPrice").val(rowdata.SALES_PRICE);
				  break;
				case "12361003":	//索赔价
					$("#partSalesPrice").val(rowdata.CLAIM_PRICE);
				  break;	
				case "12361004":	//网点价
					$("#partSalesPrice").val(rowdata.NODE_PRICE);
				  break;	
				case "12361005":	//最新进货价
					$("#partSalesPrice").val(rowdata.LATEST_PRICE);
				  break;	
				case "12361006":	//含税成本价
					$("#partSalesPrice").val(rowdata.NET_COST_PRICE);
				  break;
				case "12361007":	//保险价
					$("#partSalesPrice").val(rowdata.INSURANCE_PRICE);
				  break;
				default:
					$("#partSalesPrice").val("0");
				}
					
				$("#priceRate").val("1");
				if($("#partSalesPrice").val()==""){
					$("#partSalesPrice").val("0");
				}
				
				//根据变动计算金额
				$("#partSalesAmount").val((parseFloat($("#partSalesPrice").val())
						 *parseFloat($("#priceRate").val())
						 *parseFloat($("#partQuantity").val())).toFixed(2));
			
		 	});
		}
	});
	//点击确认按钮事件
	$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
		var selectMasterRow = $("#maintainPickingTbl",getElementContext).dmsTable().getFirstSelection();
		selectMasterRow['PART_NAME'] = $("#partName").val();
		selectMasterRow['RECEIVER'] = $("#receiver").val();
		selectMasterRow['PRICE_RATE'] = $("#priceRate").val();
		selectMasterRow['PART_SALES_PRICE'] = $("#partSalesPrice").val();
		selectMasterRow['PART_QUANTITY'] = $("#partQuantity").val();
		selectMasterRow['CHARGE_PARTITION_CODE'] = $("#chargePartitionCode").val();
		var updateStatus = selectMasterRow['UPDATE_STATUS'];
		if(updateStatus != ''){
			if(updateStatus == 'U' || updateStatus == 'R'){
				selectMasterRow['UPDATE_STATUS'] == 'U';
			}
		}
		if($("#isMainPart").is(':checked')){
			selectMasterRow['IS_MAIN_PART'] = '10571001';
		}else{
			selectMasterRow['IS_MAIN_PART'] = '10571002';
		}
		$("#maintainPickingTbl",getElementContext).dmsTable().refreshTableWithForm();
		$("a[data-dismiss='modal']", container).click();
	});
});
</script>
