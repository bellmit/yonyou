<div class ="dms-search">
	<form class="form-horizontal">
		<div class="modal-body">
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="row">
				
				<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">借进单号</label>
								<div class="col-xs-8">
									<div class="input-group">
										  <input id="borrowNo" readonly  name="borrowNo" maxlength="15" 
											class="form-control" data-fieldName="BORROW_NO" type="text" /> 
										<span class="input-group-btn">
											<button class="btn default btn-sm" type="button" id="find1"  
												data-url="part/basedata/SBorrowRegi/searchSBorrowRegiItem.html" data-toggle="modal" data-width="modal-lg">
												<i class="fa fa-sitemap"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">客户代码</label>
								<div class="col-xs-8">
									<div class="input-group">
										  <input id="customerCode" readonly  name="customerCode" maxlength="12" 
											class="form-control" data-fieldName="CUSTOMER_CODE" type="text" /> 
										<span class="input-group-btn">
											<button class="btn default btn-sm" type="button" id="find2" disabled="disabled" 
												data-url="part/basedata/SBorrowRegi/searchCustomeer.html" data-toggle="modal" data-width="modal-lg">
												<i class="fa fa-sitemap"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
				<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
				<div class="form-group">
					<label class="control-label col-xs-4">客户名称</label>
					<div class="col-xs-8 ">
						<input type="text" class="form-control" id="customerName" name="customerName" 
						data-fieldName="CUSTOMER_NAME"  maxlength="120" readonly>
					</div>
				</div>
			</div>
					<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
			 	  		<div class="form-group">  
								<label class="control-label col-xs-4">借进日期</label>
									<div class="col-xs-8">
										<div class="input-group date date-picker"  id="datepicker" data-defaulttoday="true">
											<input id="borrowDate" name="borrowDate"  readonly 
									data-fieldName="BORROW_DATE"  class="form-control required" type="text" value=""/>
												 <span class="input-group-btn">
												<button class="btn default date-set" type="button">
													<i class="fa fa-calendar"></i>
												</button>
											</span>
										</div>
									</div>
								</div>
						</div> 
				
				</div>
			</div>
		</div>
	<!-- 隐藏域 -->
		 <input  id="items" name="items"   class="form-control  "  type="hidden" readonly/> <!-- type="hidden"  -->
	<div class="panel panel-default table-panel">
		<div class="panel-heading">
			<div class="pannel-name" >调拨入库信息</div>
		<div class="pannel-button">
						<div class="btn-group btn-group-sm">
						<a class="btn btn-outline" data-width="modal-lg" data-url="part/basedata/SBorrowRegi/addPartBorrowRegiItem.html"
							disabled="disabled"  id="add" data-toggle="modal"> <i class="fa fa-plus-square"></i> 新增
						</a> 
							<!-- <a class="btn blue hidden" data-width="modal-lg"  data-url="part/basedata/SBorrowRegi/addPartBorrowRegi.html"  data-width="modal-lg" 
							 id="add2" data-toggle="modal"> <i class="fa fa-plus-square"></i> 新增
						</a>  -->
						</div>
					</div>
		</div>
		<div class="panel-body">
			<table class="table table-striped table-bordered table-hover table-responsive"
				id="dms_Borrow_Regi"></table>
		</div>
	</div>
</div>
<!-- 底部按钮 -->
		<div class="modal-footer center-block">
			<!-- 	<a data-errorCallBack="true" id="create" class="btn blue"  ><i class="fa fa-plus-square"></i>新建</a> -->
				<a class="btn blue"    id="create" data-toggle="confirmation"  data-beforeRequest="true">
					 <i class="fa fa-plus-square" ></i> 新建</a> 
					 
				<a id="save" data-model="part" data-beforeRequest="true" class="btn blue ajaxrest" disabled="disabled" 
				data-validate="true" data-onclickEvent="true" data-callBack="true"><i class="fa fa-save"></i>保存</a> 
				
				<!-- 	<a id="enterRecord" data-model="repair" data-beforeRequest="true" class="btn blue ajaxrest"disabled="disabled" 
				data-validate="true" data-onclickEvent="true" data-callBack="true"><i class="fa fa-save"></i>入账</a> 
				 -->
				<a id="enterRecord" data-model="part"  data-beforeRequest="true"
					class="btn blue " disabled="disabled"  data-toggle="confirmation"  data-callBack="true"
						><i class="fa fa-plus-square"></i>入账</a> 
						
				<a class="btn blue"  disabled="disabled"  id="cancel" data-toggle="confirmation" 
				 data-beforeRequest="true"> <i class="fa fa-undo" ></i> 取消</a> 
				 
					<a id="obsolete" data-model="part" data-beforeRequest="true" class="btn blue ajaxrest" disabled="disabled" 
				data-validate="true" data-onclickEvent="true" data-callBack="true"><i class="fa fa-save"></i>作废</a> 
				
				<a id="print" data-model="part" data-beforeRequest="true" class="btn blue ajaxrest" disabled="disabled" 
				data-validate="true" data-onclickEvent="true" data-callBack="true"><i class="fa fa-print"></i>打印</a> 
				
		</div>
	</form>
</div>
<script type="text/javascript">
function isEmptyObject(obj) {
	  for (var key in obj) {
	    return false;
	  }
	  return true;
	}
	$(document).one("onload.dms",function(event,container){
		var items=[];
		$("#borrowDate", container).setElementReadOnly();
		new Datatable().initLocale({
			src : "dms_Borrow_Regi",
			container:container,
			autoHeight: false,
			isFormParam:true,
			undefinedText : "",
			mergeTotal:{
				megerCellNumber:8,
			},uniqueDataName:"PART_NO,STORAGE_CODE",
			columns : [ 
			    {title : "操作",operateFormat : [
                       {type:"edit",openWidth:"modal-lg",url:"part/basedata/SBorrowRegi/editPartBorrowRegiItem.html",
							doubleClick:true,isShow:function(value, row, index){
							//	alert(row);
								/*  var rows=$("#dms_Borrow_Regi",container).dmsTable().getRowDataByIndex();//获取表格里的所有
								$(rows).each(function(index){
								});  */
										if($("#borrowNo",container).val()==""){//表格加载时检查有没有单号
											row.FLAG="A";
										}else{
												row.FLAG="S";
										} 
								
								  if($("#print",container).attr("disabled")==undefined){
									   //入账后不可被修改
									   return false;
								   }
                    	   return true;
					   },onBeforeEvent:function(value, row, index,obje){
						// alert(row.FLAG);
							$(obje).data("pageData",row);
						 }},
					   {type : "localDel",title:"本地删除",isShow:function(value, row, index){
						   if($("#print",container).attr("disabled")==undefined){
							   //入账后不可被删除
							   return false;
						   }
							return true;
						},onBeforeEvent:function(value, row, index){
						//	alert(row.ITEM_ID);
							$("#save",container).removeAttr("disabled");//激活保存按钮
						//	console.log(items);
						//	console.log(items.length);
							if(items.length==0){
								items[0]=row.ITEM_ID;
							}
							items[items.length]=row.ITEM_ID;
						//	console.log(items);
							//$("#dms_part_allocate_in",container).dmsTable().deleteRowByIndex(index);
						},onAfterEvent:function(value, row, index){
							//alert(items);
							$("#items",container).val(items);
						}
						 } ]},
							
            {field:"STORAGE_NAME",title:"仓库",
            	   inputHiddenFormat:{hiddenFieldName:"storageCode,itemId,flag,partBatchNo",hiddenField:"STORAGE_CODE,ITEM_ID,FLAG,PART_BATCH_NO"}}, 
/*             	   {field:"FLAG",inputField:"flag",title:"标记",inputHiddenFormat:{hiddenField:"FLAG"}},    */
            	   {field:"STORAGE_POSITION_CODE",inputField:"storagePositionCode",title:"库位",inputHiddenFormat:{}},
    			{field:"PART_NO",inputField:"partNo",title:"配件代码",inputHiddenFormat:{}},
    			{field:"PART_NAME",inputField:"partName",title:"配件名称",
						inputHiddenFormat:{hiddenField:"PART_NAME"}},
    			{field:"UNIT_NAME",inputField:"unitCode",title:"计量单位",inputHiddenFormat:{hiddenField:"UNIT_CODE"}},
    			{field:"IN_QUANTITY",inputField:"inQuantity",title:"入库数量",
						inputHiddenFormat:{hiddenField:"IN_QUANTITY"},numberFormat : {decimal:2}},
    			{field:"IN_PRICE",inputField:"inPrice",title:"入库不含税单价", 
						inputHiddenFormat : {hiddenField:"IN_PRICE"},numberFormat : {decimal:4}},
    			{field:"IN_AMOUNT",inputField:"inAmount",title:"入库不含税金额",
						 inputHiddenFormat : {hiddenField:"IN_AMOUNT"},numberFormat : {decimal:2}},
						 {field:"IN_AMOUNT2",title:"&nbsp;",
							 inputHiddenFormat : {hiddenField:"IN_AMOUNT2"},numberFormat : {decimal:2}}
			],onLoadSuccess : function() {
			/* 	if($("#borrowNo",container).val()==""){//若没有调拨单号，则为新增，item_id为默认值N
					var rows=$("#dms_Borrow_Regi",container).dmsTable().getRowDataByIndex();//获取表格里的所有
				//	遍历每一行数据：
					$(rows).each(function(index){
						rows[index].ITEM_ID="N";
						rows[index].FLAG="A";
						alert(rows[index].ITEM_ID+":"+rows[index].FLAG);
					});
				}else if($("#borrowNo",container).val()!=""){
					var rows=$("#dms_Borrow_Regi",container).dmsTable().getRowDataByIndex();//获取表格里的所有
					//	遍历每一行数据：
							alert(JSON.stringify(rows))
						$(rows).each(function(index){
							//rows[index].ITEM_ID="N";
							rows[index].FLAG="S";
							alert(rows[index].ITEM_ID+":"+rows[index].FLAG);
						});
				} */
				
				//alert($("#allocateInNo",container).val());
			},	onClickRow:function(row,$this){
			}
		});
		//通过值改变事件刷新表格1
	  $("input[id='borrowNo']",container).bindChange(function(obj){
			   $("#dms_Borrow_Regi",container).dmsTable().refreshUrl(dmsCommon.getDmsPath()["part"]
			   + "/basedata/PartBorrowRegi/"+$("#borrowNo",container).val());
			//   $("#dms_Borrow_Regi",container).dmsTable().refreshTableWithForm();
			}); 
		//成功回调函数
				$("a[data-callBack='true']", container).on("callBack.dms",function(event, response) {
					 if($(this).attr('id')=="save"){
						 $("#save",container).attr("disabled","disabled");//关闭新建按钮
					//	 alert(response);//检测返回值
						 $("#borrowNo",container).setDmsValue(response);
				//	alert(items);
							items=[];
							$("#items",container).val("");
					 }
					if($(this).attr('id')=="obsolete"){
						
						dmsCommon.refreshPageByUrl("part/basedata/SBorrowRegi/searchSBorrowRegi.html",container);//刷新页面
					 }
					if($(this).attr('id')=="enterRecord"){
						$("#enterRecord",container).attr("disabled","disabled");//关闭入账按钮
						$("#add",container).attr("disabled","disabled");//关闭新增按钮
						$("#obsolete",container).attr("disabled","disabled");//关闭作废按钮
						$("#print",container).removeAttr("disabled");//打开打印按钮
						//刷新表格
						$("#dms_part_allocate_in",container).dmsTable().refreshUrl(dmsCommon.getDmsPath()["part"]
						   + "/stockmanage/allocateInOders/Items/"+$("#allocateInNo",container).val());
						   $("#dms_part_allocate_in",container).dmsTable().refreshTableWithForm();
						
						//dmsCommon.refreshPageByUrl("part/stockmanage/partallocatein/searchPartAllocateIn.html",container);//刷新页面
					 }
				});
		$("a[data-beforeRequest='true']",container).on("beforeRequest.dms",function(event,returnResult){
			 if($(this).attr('id')=="cancel"){
				//刷新表格，重新加载页面
				  dmsCommon.refreshPageByUrl("part/basedata/SBorrowRegi/searchSBorrowRegi.html",container);
				}
			 if($(this).attr('id')=="save"){
				 
				 var customerCode=$("#customerCode",container).val();
				//console.log(customerCode);
			 if(customerCode==""){
						//总共的状态类型：info、success、error、warning
							dmsCommon.tip({status:"error",msg:"供应商代码不能为空！"});
					} else{
						$(this).attr("data-method","POST");
						$(this).attr("data-url","/basedata/PartBorrowRegi/save");   
						$("#save",container).attr("disabled","disabled");//关闭保存按钮
						 $("#enterRecord",container).removeAttr("disabled");
						 $("#obsolete",container).removeAttr("disabled");
					}
				}
				 if($(this).attr('id')=="obsolete"){//作废
				//	 alert($("#customerCode",container).val()+":"+$("#borrowNo",container).val());
					 $(this).attr("data-method","DELETE");
						$(this).attr("data-url","/basedata/PartBorrowRegi/delete/"+$("#borrowNo",container).val());    
				}
			 if($(this).attr('id')=="create"){
				 $("#create",container).attr("disabled","disabled");//关闭新建按钮
				 $("#find1",container).attr("disabled","disabled");//关闭购入单号查询按钮
				 $("#buyNo",container).attr("readonly","readonly");
				 //打开查询经销商页面的按钮
					$("#borrowDate", container).removeElementReadOnly();//打开日历功能
				 $("#find2",container).removeAttr("disabled");
				 //打开 新增 和保存、取消按钮
				  $("#find4",container).removeAttr("disabled");
				 $("#add",container).removeAttr("disabled");
				 $("#cancel",container).removeAttr("disabled");
				 $("#save",container).removeAttr("disabled");
				$("#isIdleAllocation",container).selectpicker('val',12781002);
				}
				 if($(this).attr('id')=="enterRecord"){//入账前
					 var myDate = new Date();    
					myDate.toLocaleTimeString();    // 可以获取当前时间
					// alert($("#borrowNo",container).val()+":"+$("#customerCode",container).val()+":"+$("#customerName",container).val());
					 $(this).attr("data-method","POST");
					$(this).attr("data-url","/basedata/PartBorrowRegi/enterRecord/"+$("#borrowNo",container).val()+"/"
							+$("#customerCode",container).val()+"/"+$("#customerName",container).val());    
				} 
			 returnResult.status =true;
		});
		
	});
</script>       