<div class="dms-add">
	<form class="form-horizontal">
		<div class="modal-body">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="row" data-seldate="true">
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">借出单号</label>
								<div class="col-xs-8">
									<div class="input-group">
										<input type="hidden" id="storageCode"/>
										<input type="hidden" id="outQuantity"/>
										<input type="hidden" id="partNo2">
										<input id="items" name="items" class="form-control" data-fieldName="ITEM_ID" type="hidden" />
										<input id="lendNo" name="lendNo" class="form-control" data-fieldName="LEND_NO" type="text" />
										<span class="input-group-btn">
											<button class="btn default btn-sm" type="button" id="find1"
												data-url="part/stockmanage/loancheckout/outorder/checkOutOrder.html"
												data-toggle="modal" data-width="modal-lg">
												<i class="fa fa-sitemap"></i>
											</button>
											<button class="btn default input-clear" id="clear1"
												type="button">
												<i class="fa fa-close"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4"><span
									style="color: red;">*</span>客户类型</label>
								<div class="col-xs-8">
									<select id="customerType" name="customerType" data-fieldName="BORROWER_TAG"
										class="bs-select form-control required" data-dictCode="1285">
									</select>
								</div>
							</div>
						</div>
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3" id="customerName333">
							<div class="form-group">
								<label class="control-label col-xs-4"><span style="color: red;">*</span>员工姓名</label>
								<div class="col-xs-8">
									<div class="input-group">
										<input name="handler" data-fieldName="HANDLER" type="hidden" />
										<input name="OUT_AMOUNT" data-fieldName="OUT_AMOUNT" type="hidden" />	
										<input id="customerName" name="customerName" data-url="/basedata/employees" data-beforeRequest="true" class="form-control required" data-fieldName="CUSTOMER_NAME" type="text"  />
										
										<!-- <select id="customerName" class="bs-select form-control required"
											data-ajaxSync="true" name="customerName"
											data-url="/basedata/employees" data-model="manage"
											data-labelValue="CUSTOMER_NAME" data-beforeRequest="true"
											data-lableDesc="CUSTOMER_NAME" data-alwaysRefresh="true">
										</select> -->
											
										<span class="input-group-btn">
											<button class="btn default btn-sm" type="button" id="find" name="find" 
												data-url="part/stockmanage/loancheckout/employee.html"
												data-toggle="modal" data-width="modal-lg">
												<i class="fa fa-sitemap"></i>
											</button>
											<button class="btn default input-clear" id="clear" name="clear" 
												type="button">
												<i class="fa fa-close"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div> 
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3" id="customerCode222">
							<div class="form-group">
								<label class="control-label col-xs-4"><span
									style="color: red;">*</span>客户代码</label>
								<div class="col-xs-8">
									<div class="input-group">
										<input id="customerCode" name="customerCode" disabled="disabled" data-beforeRequest="true" class="form-control required" data-fieldName="CUSTOMER_CODE" type="text"  />
										<span class="input-group-btn">
											<button class="btn default btn-sm" type="button" id="find" name="find" data-onclickEvent="true"
												data-url="part/stockmanage/partallocatein/searchCustomeer.html" disabled="disabled"
												data-toggle="modal" data-width="modal-lg">
												<i class="fa fa-sitemap"></i>
											</button>
											<button class="btn default input-clear" id="clear" name="clear" disabled="disabled"
												type="button">
												<i class="fa fa-close"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3" id="customerCode444">
							<div class="form-group">
								<label class="control-label col-xs-2"></label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="customerName2" readonly
										data-fieldName="CUSTOMER_NAME" name="customerName2" />
								</div>
							</div>
						</div>
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">开单日期</label>
								<div class="col-xs-8">
									<div class="input-group date date-picker">
										<input id="createDate" name="sheetCreateDate" readonly
											data-fieldName="SHEET_CREATE_DATE" class="form-control"
											type="text" /> 
										<span class="input-group-btn">
											<button class="btn default date-set" type="button">
												<i class="fa fa-calendar"></i>
											</button>
											<button class="btn default date-reset" type="button">
												<i class="fa fa-times"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
						<!-- /span -->
						<div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
							<div class="form-group">
								<label class="control-label col-xs-4">借出日期</label>
								<div class="col-xs-8">
									<div class="input-group date date-picker">
										<input id="lendDate" name="lendDate" readonly
											data-fieldName="LEND_DATE" class="form-control"
											type="text" /> 
										<span class="input-group-btn">
											<button class="btn default date-set" type="button">
												<i class="fa fa-calendar"></i>
											</button>
											<button class="btn default date-reset" type="button">
												<i class="fa fa-times"></i>
											</button>
										</span>
									</div>
								</div>
							</div>
						</div>
						<!-- /span -->
					</div>
				</div>
			</div>
			<div class="panel panel-default table-panel">
				<div class="panel-heading">
					<div class="pannel-name">借出登记</div>
					<div class="pannel-button">
						<div class="btn-group btn-group-sm">
							<a id="add" data-url="part/stockmanage/loancheckout/addCheckOut.html" class="btn btn-outline" data-toggle="modal" data-width="modal-lg"> <i class="fa fa-plus-square"></i> 新增</a>
							<a id="outter" data-callBack="true" data-model="part" method="POST" data-toggle="confirmation" data-beforeRequest="true" class="btn btn-outline"> <i class="fa fa-plus-square"></i>出库</a> 
							<a id="cancel" data-model="part" method="DELETE" data-toggle="confirmation" data-onclickEvent="true" class="btn btn-outline"> <i class="fa fa-plus-square"></i>作废</a>
						</div>
					</div>
				</div>
				<div class="panel-body">
					<table class="table table-striped table-bordered table-hover table-responsive" id="dms_checkout"></table>
				</div>
			</div>
		</div>
		<!-- 底部按钮 -->
		<div class="modal-footer center-block">
			<a data-errorCallBack="true" id="create" class="btn blue"><i class="fa fa-plus-square"></i>新建</a>
		 	<a id="save" data-url="/part/lendOrderChoose/btnSave" data-model="part" data-beforeRequest="true" disabled="disabled"
				data-callBack="true" data-method="POST" class="btn blue ajaxrest"><i class="fa fa-save"></i>保存 </a>   
			<a id="exit" class="btn blue" disabled="disbaled" ><i class="fa fa-print"></i>取消</a>
		</div>
	</form>
</div>
<script type="text/javascript">
	$(document).one("onload.dms",function(event, container){
		
		//客户类型
		$("#customerType",container).on('change',function(){
			var flag = $(this).val();
			if(flag=='12851001'){//客户
				/* $("#tb",container).attr('disabled',"true"); */
				$("#customerCode222",container).show();//显示
				$("#customerName333",container).hide();//隐藏
				$("#customerCode444",container).show();
				$("#find",container).removeAttr("disabled");
				$("#clear",container).removeAttr("disabled");
			}else{//员工
				$("#customerCode222",container).hide();
				$("#customerName333",container).show();
				$("#customerCode444",container).hide();
			}
		});
		
		$("#customerName333",container).hide();
		$("#add", container).setElementReadOnly();
		$("#customerType", container).setElementReadOnly();
		
		$("#createDate", container).setElementReadOnly();
		$("#lendDate", container).setElementReadOnly();
		$("#outter", container).setElementReadOnly();
		$("#cancel", container).setElementReadOnly();
		
		
		new Datatable().initPagination({
			src : "dms_checkout",
			container:container,
			rowID : "ITEM_ID",
			selectItemName:"ITEM_ID",
			autoHeight : false,
			isQueryFirst : false,
			checkboxHeader : true, //全选框
			undefinedText : "",
			uniqueDataName:"ITEM_ID",
   			clickToSelect: false,
			columns : [  {checkbox : true,sortable : false},
						{title : "操作",operateFormat : [
						{type : "localDel",onAfterEvent:function(value, row, index){},onBeforeEvent:function(value, row, index){
							/* var items=[]; */
							debugger
							alert($("#items",container).val());
			            	$("#save",container).removeAttr('disabled');
							
							if(items.length==0){
								items[0]=row.ITEM_ID;
							}
							items[items.length]=row.ITEM_ID;
							
						},onAfterEvent:function(value, row, index){
			            	$("#items",container).val(items);
			            },isShow:function(value, row, index){
			            	if(row.IS_FINISHED==12781001){
			            		return false;
			            	}else{
				            	return true;
			            	}
			            }
						},						
			            {type:"edit",url:"part/stockmanage/loancheckout/editLendNo.html",openWidth : "modal-lg",doubleClick:true,isShow:function(value, row, index){
							   if(row.LOCK_USERU==""||row.LOCK_USERU==null||row.LOCK_USERU==$("#userId",container).val()){
								   return true;
	                    	   }else{
	                    		   return false;
	                    	   }
	                    	   },onBeforeEvent:function(value,row,index,obje){
	                    		   $(obje).data("pageData",row);
						   }},
						]}, 
						{field : "update_status",title : "",inputHiddenFormat:{}},
						{field : "IS_FINISHED",title : "是否入账",codeFormat : {type : "dict",codeType : "1278"},visible:false},
			            {field : "STORAGE_CODE",title : "仓库",inputHiddenFormat:{}},
			            {field : "STORAGE_POSITION_CODE",title:"库位",inputHiddenFormat:{}},
						{field : "PART_NO",title : "配件代码",inputHiddenFormat:{}},
						{field : "PART_NAME",title : "配件名称",inputHiddenFormat:{}},
						{field : "UNIT_CODE",title : "计量单位",inputHiddenFormat:{}},
						{field : "OUT_QUANTITY",title : "出库数量",inputHiddenFormat:{}},
						{field : "COST_PRICE",title : "成本单价",numberFormat : {decimal:2},inputHiddenFormat:{}},
						{field : "COST_AMOUNT",title : "成本金额",numberFormat : {decimal:2},inputHiddenFormat:{hiddenField:"COST_AMOUNT"}},
						{field : "OUT_PRICE",title : "出库单价",numberFormat : {decimal:2},inputHiddenFormat:{}},
						{field : "OUT_AMOUNT",title : "出库金额",numberFormat : {decimal:2},inputHiddenFormat:{hiddenField:"OUT_AMOUNT"}},
						{field : "PRICE_RATE",title : "价格系数",inputHiddenFormat:{},visible:false},
						{field : "SALES_BASE_PRICE_TYPE",title : "价格类型",inputHiddenFormat:{},visible:false},
				]
		});
		
		//借出单号绑定改变事件
		$("#lendNo", container).bindChange(function(obj){
			if($("input[name='lendNo']").val()!=null&&$("input[name='lendNo']").val()!=''){
				$("#dms_checkout",getElementContext()).dmsTable().refreshUrl(dmsCommon.getDmsPath()["part"] + "/part/lendOrderChoose/"+$('#lendNo',container).val());
 				$("#dms_checkout", getElementContext()).dmsTable().refreshTableWithForm();
				$("#customerType", container).removeElementReadOnly();
				
				$("#add", container).removeElementReadOnly();
				
				$("#outter", container).removeElementReadOnly();
				$("#cancel", container).removeElementReadOnly();
				$("#create",container).attr('disabled','disabled');
				$("#save",container).attr('disabled','disabled');
				
				$("#lendNo", container).setElementReadOnly();
				$("#exit", container).removeAttr("disabled");
				
			}else{
				$("#create",container).removeAttr('disabled');
			}
		});
		
		//执行校验
		$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
			if(isStringNull($("#customerType",container).val())){
				dmsCommon.tip({status:"warning",msg:"请选择业务往来客户类型!"});
				returnResult.status = false;
				return ;
			}
		});
		
		//保存,批量出库前事件
		$('a[data-beforeRequest="true"]',container).on('beforeRequest.dms',function(event,returnResult){
			
			if($(this).attr('id')=='save'){
				if($(this).attr('disabled')!='disabled'){//防止禁用时误点
					var selectRow = $("#dms_checkout",container).dmsTable().getSelections();
					if(selectRow!=null){
						returnResult.status = true;
					}else{
						dmsCommon.tip({status:"warning",msg:"请选择需要保存的列！"});
						returnResult.status=false;
					}
				}
			}else{
				if($(this).attr('disabled')!='disabled'){
					debugger
					var selectRow = $("#dms_checkout",container).dmsTable().getSelections();
					console.log(JSON.stringify(selectRow));
					if(selectRow!=null){
						var checkFinish = false;//判断是否入账
						var storageCode = "";//用来选择出库的仓库代码
						var outQuantity = "";//用来选择出库的配件数量
						var partNo2 = "";
						$.each(selectRow,function(index,row){
							if(row.IS_FINISHED!='12781002'){//表示已经入账
								checkFinish = true;
							}
							/* storageCode += row.STORAGE_CODE+","; *///存储STORAGE_CODE代码用','分割
							storageCode += row.STORAGE_CODE;//存储STORAGE_CODE代码用','分割
							/* outQuantity += row.OUT_QUANTITY+","; *///存储OUT_QUANTITY数量用','分割
							outQuantity += row.OUT_QUANTITY;//存储OUT_QUANTITY数量用','分割
							/* partNo2 +=row.PART_NO+","; */
							partNo2 +=row.PART_NO;
						});
						
						if(checkFinish){//判断是否入账
							dmsCommon.tip({status:"warning",msg:"已经入账的配件不能再次出库！"});
							returnResult.status=false;
						}else{
							//请求,查询是否为负库存
							$("#outter",container).attr("data-url","/part/lendOrderChoose/"+partNo2+"/"+storageCode+"/"+outQuantity)
							$(this).attr("data-method","POST");
							returnResult.status=true;
						}
					}else{
					    dmsCommon.tip({status:"warning",msg:"请选择需要出库的列！"});
						returnResult.status=false;
					}
				}
			}
		});
		
		//作废按钮操作
		$("a[data-onclickEvent='true']",container).on("dms.click",function(event){
			debugger
			var selectRow = $("#dms_checkout",container).dmsTable().getSelections();
			console.log(JSON.stringify(selectRow));
			$("#cancel",container).attr("data-url","/part/lendOrderChoose/delete/"+$("#lendNo",container).val())
			$(this).attr("data-method","DELETE");
			returnResult.status=true;
			
		});
		
		
		//保存的回调函数
		$("a[data-callBack='true']",container).on("callBack.dms",function(event,response){
			debugger
			$("#save", container).attr('disabled','disabled');
			$("#outter", container).removeElementReadOnly();
			$("#cancel", container).removeElementReadOnly();
			if($(this).attr('id')=='save'){
				$("input[name='lendNo']").val(response);
			}
			$("#dms_checkout",getElementContext()).dmsTable().refreshUrl(dmsCommon.getDmsPath()["part"] + "/part/lendOrderChoose/"+$('#lendNo',container).val());
 			$("#dms_checkout", getElementContext()).dmsTable().refreshTableWithForm();
			if($(this).attr('id')=='outter'){
				console.log(JSON.stringify(response));
				if(response==0){
					dmsCommon.tip({status:"warning",msg:"该配件在配件仓库中或者零库存,无法出库！"});
				}else{
					//把查询是否负库存（response）带回来的值穿到下一个页面
					$(container).data("pageData",{PART_NO:response.PART_NO,STORAGE_CODE:response.STORAGE_CODE,LEND_NO:response.LEND_NO});
					dmsCommon.refreshPageByUrl("part/stockmanage/loancheckout/account.html",container);
				}
			}
		});
		
		
		//新建按钮
		$("#create", container).click(function(){
			
			$("#add", container).removeElementReadOnly();
			$("#lendNo", container).setElementReadOnly();
			$("#customerType", container).removeElementReadOnly();
			$("#customerCode",container).removeAttr("disabled","disabled");
			
			
			
			$("#createDate",container).removeAttr("readonly");
			$("#createDate",container).val(new Date().Format("yyyy-MM-dd"));
			$("#createDate",container).setElementReadOnly();
			
			$("#lendDate",container).removeElementReadOnly();
			$("#lendDate",container).val(new Date().Format("yyyy-MM-dd"));
			
			$("#save", container).removeAttr("disabled");
			$("#exit", container).removeAttr("disabled");
			
			$(this).attr('disabled','disabled');
			
			
		});
		
		//取消按钮
			$("#exit", container).click(function(){
			 dmsCommon.refreshPageByUrl("part/stockmanage/loancheckout/checkout.html",container);
		});
		
	});
Date.prototype.Format = function (fmt) { //author: wx
	    var o = {
	        "M+": this.getMonth() + 1, //月份 
	        "d+": this.getDate(), //日 
	        "h+": this.getHours(), //小时 
	        "m+": this.getMinutes(), //分 
	        "s+": this.getSeconds(), //秒 
	        "q+": Math.floor((this.getMonth() + 3) / 3), //季度 
	        "S": this.getMilliseconds() //毫秒 
	    };
	    if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
	    for (var k in o)
	    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
	    return fmt;
	}
</script>