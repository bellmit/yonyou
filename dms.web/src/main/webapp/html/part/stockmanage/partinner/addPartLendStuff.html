<div class="dms-search">
	<form class="form-horizontal">
		<div class="modal-header">
			<div class="modal-title">车间借料新增</div>
			<div class="modal-close">
				<a data-dismiss="modal" class="btn btn-lg"> <i
					class="fa fa-remove"></i></a>
			</div>
		</div>
		<div class="modal-body">
			<div class="panel panel-default">
				<div class="panel-body">
					<div class="row ">
						<div class="col-xs-12 col-sm-6 col-md-3 ">
							<div class="form-group form-group-xs m-b-xs">
								<label class="control-label col-xs-4 ">仓库</label>
								<div class="col-xs-8">
								<select id="STORAGE_CODE" name="STORAGE_CODE" class="bs-select form-control" 
								data-url="/partStocks/StockCode" data-model="part" data-labelValue="STORAGE_CODE" data-lableDesc="STORAGE_NAME"></select>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3">
							<div class="form-group">
								<label class="control-label col-xs-4">品牌</label>
								<div class="col-xs-8">
									<select id="brand" name="brand" data-ajaxSync="true"
										class="bs-select form-control" data-url="/basedata/brandsdict"
										data-model="manage" data-labelValue="BRAND_CODE"
										data-lableDesc="BRAND_NAME">
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">配件代码</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="PART_NO"
										name="PART_NO">
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">拼音</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="SPELL_CODE"
										name="SPELL_CODE">
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">名称</label>
								<div class="col-xs-8">
									<input type="text" class="form-control" id="PART_NAME"
										name="PART_NAME">
									<input type="hidden" id="COST_PRICE" name="COST_PRICE" data-fieldName="COST_PRICE"/>	
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3">
							<div class="form-group">
								<label class="control-label col-xs-4">配件类别</label>
								<div class="col-xs-8">
									<select id="partGroupCode" name="PART_GROUP_CODE"
										data-ajaxSync="true" class="bs-select form-control"
										data-fieldName="PART_GROUP_CODE" data-dictCode="1136">
									</select>
								</div>
							</div>
						</div>
						<input type="hidden" id="OPTION_NO" name="OPTION_NO"/>
						<div class="col-xs-12 col-sm-6 col-md-3 ">
							<div class="form-group">
								<label class="control-label col-xs-4 ">库位</label>
								<div class="col-xs-8">
									<input type="text" class="form-control"
										id="STORAGE_POSITION_CODE" name="STORAGE_POSITION_CODE" >
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-3">
							<div class="form-group">
								<label class="control-label col-xs-4">配件车型组</label>
								<div class="col-xs-8 ">
									<select id="PART_MODEL_GROUP_CODE_SET"
										name="PART_MODEL_GROUP_CODE_SET" data-ajaxSync="true"
										class="bs-select form-control"
										data-url="/basedata/partInfos/querypartGroupCodes"
										data-model="part" data-labelValue="PART_MODEL_GROUP_CODE"
										data-lableDesc="PART_MODEL_GROUP_NAME">
									</select>
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3">
							<div class="form-group">
								<label class="control-label col-xs-4 "></label>
								<div class="col-xs-8">
									<input id="isCheck" name="isCheck" type="checkbox"
										data-dictCode="1057" data-dictLabel="库存大于零" data-value="10571001"
										data-autoValueDigits="2" />
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-3">
							<div class="form-group">
								<div class="col-xs-12">
									<input type="checkbox" name="isSalePriceBigger"
										id="isSalePriceBigger" data-dictCode="1057"
										data-dictLabel="售价大于零(最多查询记录500条)" />
								</div>
							</div>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-6 ">
							<div class="form-group">
								<label class="control-label col-xs-2 ">备注</label>
								<div class="col-xs-10">
									<input type="text" class="form-control" id="REMARK" name="REMARK">
								</div>
							</div>
						</div>
					</div>
					<div class="row ">
						<div class="col-xs-12 ">
							<div class="query-btn">
								<a href="javascript:;" class="btn blue"><i class="fa fa-search"></i>查询</a>
								<a data-model="part" data-method="GET" class="btn blue ajaxrest" data-beforeRequest="true"
								   data-validate="true" data-model="part"><i class="fa fa-plus-square"></i>替换件</a>
								<a href="javascript:;" class="btn blue"><i class="fa fa-undo"></i>重置</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel panel-default table-panel">
			<div
				style="border: solid 1px #DDDDDD; height: 150px; overflow-y: scroll; overflow-x: hidden">
				<table
					class="table table-striped table-bordered table-hover table-responsive"
					id="dms_table"></table>
			</div>
		</div>
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="row ">
					<div class="col-xs-12 col-sm-6 col-md-3 ">
						<div class="form-group">
							<label class="control-label col-xs-4 ">仓库</label>
							<div class="col-xs-8">
								<input id="storageName" name="storageName" class="bs-select form-control" disabled="disabled"/>
								<input type="hidden" class="form-control" id="storagePositionCode" name="storagePositionCode"/>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 ">
						<div class="form-group">
							<label class="control-label col-xs-4 ">配件代码</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id="partNo" name="partNo" disabled="disabled">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3 ">
						<div class="form-group">
							<label class="control-label col-xs-4 ">配件名称</label>
							<div class="col-xs-8">
								<input type="text" class="form-control" id="partName" name="partName" disabled="disabled">
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3">
						<div class="form-group">
							<label class="control-label col-xs-4">借出数量</label>
							<div class="col-xs-8">
								<input id="canLendNum" name="canLendNum" class="form-control required" type="text" value="1.00"/>
								<input type="hidden" class="form-control" id="enableNum" name="enableNum"/>
								<input type="hidden" class="form-control" id="unitName" name="unitName"/>
							</div>
						</div>
					</div>
					<div class="col-xs-12 col-sm-6 col-md-3">
						<div class="form-group">
							<label class="control-label col-xs-4">借用人</label>
							<div class="col-xs-8 ">
								<select class="bs-select form-control required" id="customerManager" name="customerManager"
								data-url="/basedata/ownerWeChatBooking/findEmployees" data-model="repair" data-labelValue="EMPLOYEE_NO" data-lableDesc="EMPLOYEE_NAME"></select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="panel panel-default table-panel">
			<div class="panel-body"
				style="border: solid 1px #DDDDDD; height: 150px; overflow-y: scroll; overflow-x: hidden">
				<table
					class="table table-striped table-bordered table-hover table-responsive"
					id="dms_table2"></table>
			</div>
		</div>
		<div class="modal-footer center-block">
			<a data-url="" data-model="part"
				data-method="POST" data-onclickEvent="true" class="btn blue" ><i class="fa fa-save"></i>确定</a> <a
				data-dismiss="modal" class="btn blue"> <i class="fa fa-undo"></i>取消
			</a>
		</div>
	</form>
</div>
<script type="text/javascript">
	$(document).one("onload.dms",function(event,container){
		new Datatable().initPagination({
			src : "dms_table",
			container:container,
			url : dmsCommon.getDmsPath()["part"] + "/basedata/BookPart/part",
			rowID : "PART_NO,STORAGE_CODE,PART_BATCH_NO",
			isFormParam:true,
			isQueryFirst:true,
			undefinedText : "",
			autoHeight : false,
			onDblClickRow:function(rowData,trElement){
				var partNo = rowData.PART_NO;
                var storageCode = rowData.STORAGE_CODE;
                var partName2 = rowData.PART_NAME;
                $("#partNo").val(partNo);
                $("#storageName").val(rowData.STORAGE_NAME);
                $("#storagePositionCode").val(rowData.STORAGE_POSITION_CODE);
                $("#partName").val(partName2);
                $("#unitName").val(rowData.UNIT_NAME);
                $("#dms_table2",getElementContext()).dmsTable().refreshUrl(dmsCommon.getDmsPath()['part']+"/basedata/BookPart/parts/"+partNo+"/"+storageCode);//通过url刷新表格
                $("#dms_table2", getElementContext()).dmsTable().refreshTableWithForm();
			},
			columns : [ 
				{radio:true,sortable : false},
			    {field : "STORAGE_CODE",title : "仓库"}, 
			    {field : "STORAGE_NAME",visible:false,title : "仓库名称"}, 
			    {field : "UNIT_NAME",visible:false,title : "计量单位"},
				{field : "STORAGE_POSITION_CODE",title : "库位"}, 
				{field : "PART_NO",title : "配件代码"}, 
				{field : "PART_NAME",title : "配件名称"},
				{field : "PART_MODEL_GROUP_CODE",title : "车型组集"},
				{field : "PART_BATCH_NO",title : "进货批号"},
				{field : "SALES_PRICE",title : "销售价"},
				{field : "COST_PRICE",title : "成本价"},
				{field : "STOCK_QUANTITY",title : "账面库存"},
				{field : "BORROW_QUANTITY",title : "借进数量"},
				{field : "LEND_QUANTITY",title : "借出数量"},
				{field : "REMARK",title : "备注"}
			]
		});
		new Datatable().initPagination({
			src : "dms_table2",
			container:container,
			url : dmsCommon.getDmsPath()["part"] + "",
			rowID : "PART_NO,STORAGE_CODE",
			isFormParam:true,
			undefinedText : "",
			isQueryFirst:false,
			autoHeight : false,
			columns : [ 
			    {field : "SALES_PRICE",title : "销售价"}, 
				{field : "CLAIM_PRICE",title : "索赔价"}, 
				{field : "INSURANCE_PRICE",title : "保险价"}, 
				{field : "MIN_LIMIT_PRICE",title : "最低销售限价"},
				{field : "LIMIT_PRICE",title : "销售限价"},
				{field : "max_Stock",title : "最大库存"},
				{field : "min_stock",title : "最小库存"},
				{field : "STOCK_QUANTITY",title : "账面库存"},
				{field : "USEABLE_STOCK",title : "可用库存"},
				{field : "BORROW_QUANTITY",title : "借进数量"},
				{field : "LEND_QUANTITY",title : "借出数量"},
				{field : "LOCKED_QUANTITY",title : "锁定量"},
				{field : "OPTION_NO",title : "替代配件"},
				{field : "OPTION_STOCK",title : "替代件库存"},
				{field : "PART_GROUP_CODE",title : "配件类别"},
				{field : "UNIT",title : "单位"},
				{field : "PART_MODEL_GROUP_CODE_SET",title : "配件车型组集"}]
		}); 
		
		$("a[data-beforeRequest='true']",container).on("beforeRequest.dms",function(event,returnResult){
			var selectRow = $("#dms_table",container).dmsTable().getSelections();
			if($("#OPTION_NO",container).val()==''){
				dmsCommon.tip({status:"warning",msg:"配件："+selectRow[0]['PART_NO']+"没有替换件！"});
			}else{
				$(this).attr("data-url","/basedata/BookPart/replace/"+selectRow[0]['PART_NO']);
				returnResult.status = true;
			}
		});
		
		//新增页面回调函数
		$("a[data-onclickEvent='true']",container).on("dms.click",function(obj){
			var partNo=$("#partNo",container).val();
			if(partNo==null||partNo==""){
				dmsCommon.tip({status:"warning",msg:"请选择配件"});
				return ;
			}
			if($("#canLendNum",container).validateElement()&&$("#customerManager",container).validateElement()){
				var formJson={};
				formJson["storageName"]=$("#storageName").val();
				formJson["storagePositionCode"]=$("#storagePositionCode").val();
				formJson["partNo"]=$("#partNo").val();
				formJson["partName"]=$("#partName").val();
				formJson["unitName"]=$("#unitName").val();
				formJson["canLendNum"]=$("#canLendNum").val();
				formJson["customerManager"]=$('option:selected',$("#customerManager",container)).text();
				var enableNum = $("#enableNum",container).val();
				var canLendNum = $("#canLendNum",container).val();
				if(parseFloat(canLendNum)>parseFloat(enableNum)){
					dmsCommon.tip({status:"warning",msg:"配件实际出库数量不能大于账面库存数量!"});
					return ;
				}
				$("#workshop_item",getElementContext()).dmsTable().appendRow(formJson,true);
			}	
		});
	});
</script>
